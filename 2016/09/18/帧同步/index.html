<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	 <link rel="shortcut icon" href="/img/logo_miccall.png">
	
			
    <title>
    Elays'Blog
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
			    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    
		
<!-- Layouts -->


<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML" async>
</script>

<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_undefined.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MICCALL</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Boost/">Boost</a></li><li><a class="category-link" href="/categories/C-语法/">C#语法</a></li><li><a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/C语言/">C语言</a></li><li><a class="category-link" href="/categories/Math/">Math</a></li><li><a class="category-link" href="/categories/OpenGL/">OpenGL</a></li><li><a class="category-link" href="/categories/c/">c++</a></li><li><a class="category-link" href="/categories/全局光照/">全局光照</a></li><li><a class="category-link" href="/categories/博客配置/">博客配置</a></li><li><a class="category-link" href="/categories/并行计算/">并行计算</a></li><li><a class="category-link" href="/categories/操作系统/">操作系统</a></li><li><a class="category-link" href="/categories/数据结构/">数据结构</a></li><li><a class="category-link" href="/categories/毕设/">毕设</a></li><li><a class="category-link" href="/categories/游戏开发/">游戏开发</a></li><li><a class="category-link" href="/categories/游戏设计模式/">游戏设计模式</a></li><li><a class="category-link" href="/categories/计算机图形学/">计算机图形学</a></li><li><a class="category-link" href="/categories/计算机系统/">计算机系统</a></li><li><a class="category-link" href="/categories/设计模式/">设计模式</a></li><li><a class="category-link" href="/categories/调试错误集锦/">调试错误集锦</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="搜索">
		                搜索
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		                <li><a href="https://github.com/miccall" class="icon fa-github"><span class="label">GitHub</span></a></li>
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(undefined);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >网游流畅基础：帧同步游戏开发</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
				<!-- 目录 -->
				<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:none">
				<span class="btn-bg"></span>
				<span class="btn-text">文章导航</span>
				</p>
				<div id="toc-article" class="toc-article">
					<span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">×</span>
					<strong class="toc-title">文章目录</strong>
					
			   </div>
			   <script type="text/javascript">
				function showToc(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:block");
					show_toc_btn.setAttribute("style","display:none");
					};
				function showBtn(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:none");
					show_toc_btn.setAttribute("style","display:block");
					};
			   </script>
				
                <p>在现代多人游戏中，多个客户端之间的通讯，主要是同步多方状态。为了同步多方状态，主要有两个技术：<br><a id="more"></a></p>
<ol>
<li>状态同步<br>客户端发送游戏动作到服务器，服务器收到后，计算游戏行为的结果，然后以广播的方式下发游戏中各种状态，客户端收到状态后再根据状态显示内容。在回合制游戏中，大多都是这种方式</li>
<li>帧同步<br>也是客户端发送游戏动作到服务器，服务器收到后并不计算游戏行为结果，只是转发所有客户端的动作（或者不需要服务器，客户端之间直接通过P2P技术发送游戏动作）。然后客户端根据收到的所有游戏动作来做游戏运算和显示。早期的IPX（Internetwork Parket Exchange Protocol，互联网数据包交换协议）网络游戏就是这种帧同步的方式，比如红色警戒、星际争霸和大量的支持网络连线双打的游戏机模拟器。</li>
</ol>
<hr>
<p><font size="5" color="orange">什么时候用状态同步，什么时候用帧同步？</font><br>状态同步主要是依靠服务器来计算游戏状态，然后下发到客户端，而帧同步主要是依靠客户端自己来做游戏运算，服务器仅仅是做一个转发，甚至不需要服务器，客户端之间可以通过P2P方式来转发数据。</p>
<p>由于帧同步只是转发游戏行为，而不是游戏状态，所以要广播的数据量比状态同步要小很多，比较适合游戏行为非常频繁的动作类游戏，比如飞行射击、FPS（First Person Shooting Game，第一人称射击类游戏）、RTS（Real Time Strategy Game，即时战略游戏）这些游戏。因为这些游戏中的对象特别多，比如满屏的子弹，如果使用状态同步，那么服务器要广播的数据就很大了，但是如果用帧同步，则仅仅需要广播与玩家角色有关的动作即可，像在射击游戏中其余的满屏的子弹（这些都是有机器控制的，不是玩家控制的）都不需要广播数据了。这个时候帧同步的优势很明显。</p>
<p>反过来，如果游戏里有大量的玩家，那么帧同步和状态同步的差异就不明显了，因为与每一个玩家相关的动作都需要做广播。而且状态同步由于是在服务器上进行游戏运算，安全性会更高，比较容易防止外挂。</p>
<hr>
<p><font size="5" color="orange">帧同步机制</font><br>帧同步最重要的基础概念：<strong>相同的输入+相同的时机=相同的显示</strong><br>意思是每个客户端在同一时间收到的，来自网络中多个客户端的操作是一样的，就能够达到同步效果。</p>
<p>由于在同步中每个客户端的运算要绝对一致，所以不能依赖本地时间、本地随机数等等类似的操作，而应该是以来自网络的操作数据为主。所以，在游戏客户端引擎中的本地Update就不能再在每帧画面渲染前被调用了，因为它是依赖本地时间的。Update总不能省掉吧？因为它是游戏逻辑更新的主循环，没有它游戏就没法动了。既然Update是必须的，那么什么时候调用它才能保证同步呢？</p>
<p>在一般的帧同步系统中，会有一个Relay Server负责广播所有客户端的数据，并且由于每个客户端不能依靠本地时间来驱动Update，只能依靠来自网络的数据。所以，Relay Server会每隔一定时间向所有客户端下发“网络帧”，当有玩家有输入的时候，把玩家的游戏操作数据填入到网络帧数据包中，再进行广播，如果没有玩家输入，则发送空（大部分是空的）的网络帧。当每个客户端收到网络帧的时候，就会调用一个UpdateByNet()函数来进行游戏更新。（UpdateByNet其实干的是和Update差不多的事，只是受驱动的对象变了，Update受本地CPU驱动，UpdateByNet受网络驱动。而且帧同步中Update函数依然存在，也会受CPU驱动执行，不过其中的大部分内容都挪到了UpdateByNet中，所以Update的更新不再会产生游戏逻辑的更新，UpdateByNet才会）。</p>
<p>显然网络帧的速度要比本地CPU帧速度慢很多，帧率会很低。那么怎么保证游戏流畅度呢？</p>
<hr>
<p><font size="5" color="orange">帧同步中如何保证游戏流畅</font></p>
<ul>
<li>Delay Server每一个网络帧广播的数据应该要足够小，最好在一个 MTU（Max Transmission Unit ）以下，这样才能有效降低网络延迟。</li>
<li>为了让Delay Server每次广播的数据量小，一般要求每次客户端发送的数据应该小于128字节</li>
<li>一个减少客户端发送数据长度的方法就是：自己写序列化函数。一般的面向对象语言都带有把对象序列化和反序列化的功能，但是编程语言的默认序列化功能，为了实现一些高级功能（比如反射），会把很多游戏逻辑所不必要的数据也序列化了（比如对象类名、属性名）。所以我们可以自己针对特定的对象来编写序列化函数，来减少多余的数据，甚至能合并和裁剪一些数据项，以最小化数据长度。<br><img src="http://cfwjm.img48.wal8.com/img48/559974_20161023165829/147721530598.png" alt=""></li>
<li>另一个减少客户端发送数据长度的方法是：用整数代替浮点数。比如在游戏中所使用的位置数据，大多是浮点数，占了8个字节，其实往往我们并不需要这么高的精确度，所以可以考虑把浮点数变成整数，整数只占了4个字节，少了一倍的数据量。最简单的方法是把浮点数乘以1000或100然后取整（客户端接收到以后可以除以1000或100来还原，这样在保证整数的同时还能有一定的精确度）。</li>
<li>还有一个减少客户端发送数据长度的必要方法是：只有当客户端收到网络下行帧以后才发送一次上行的玩家操作，而不是每一个渲染帧（本地Update）都去发送。</li>
<li>玩家的网络可能会出现临时拥堵（网络抖动），也有可能中途会有玩家加进来，甚至游戏录像等等都会导致客户端收到一堆“过去时间”里的网络帧，无法即时处理。这时就要求玩家恢复正常状态后，要有处理这一堆网络数据的能力。最简单的办法就是加速播放（快进或者叫拉帧）：客户端收到网络帧处理完游戏逻辑后，在同一个渲染帧（本地Update）内，马上重复接收下一个网络帧（而不再是直到下一次Delay Server广播时才再次接收网络帧），然后又立即处理。这样往往能在一个渲染帧的时间内，加速赶上服务器广播的最新游戏进度（赶上其他正常玩家的当前游戏状态）。<br><img src="http://cfwjm.img48.wal8.com/img48/559974_20161023165829/14772153066.png" alt=""><br>但是也有副作用，如果客户端积累的包太多（比如游戏已经开始10分钟，新玩家中途加入），客户端会因为在一个渲染帧内疯狂下载积累的帧同步包和快进运算，导致本地客户端长时间卡住。所以有时候会限制一个渲染帧内快进的次数，保证用户还是能看到活动的画面（虽然动的比较快但也总比一直静止好啊！）。如果帧同步包实在是太多，要快进的进度很多，那么就要采用“快照”技术了。</li>
<li>客户端在快进时，每个渲染帧会接收很多网络帧，因为每收到一个网络帧都会发送一次玩家操作数据，这回导致Delay Server广播的数据量很大，造成网络延迟。所以当某个客户端在快进时，应该禁止输入玩家输入，那么每次收到网络帧后由于没有玩家输入就不会再进行数据发送了。</li>
<li>为了提高实时性，一般使用UDP，而不是TCP，但是使用UDP又会带来丢包、乱序。所以，一般会采用冗余的方式，每个网络帧数据包其实还包含了过去2帧的数据，也就是说每次发3帧数据来对抗丢包，3个包里只要有一个包没丢就不会影响游戏。</li>
<li>Delay Server上还会保存大量的客户端上传的数据，如果客户端发现丢包或者乱序，就会发起一次“下载”请求，从 Delay Server上重新下载丢失或乱序的帧数据包（这可能会使用TCP）。</li>
<li><p><font size="4" color="red">通过牺牲某些不重要的特性来提高游戏流畅度</font></p>
<ul>
<li>牺牲<strong>一致性</strong>来交换流畅度。虽然帧同步的目标就是所有客户端都看到一致的显示，但是游戏内容很多，有一部分内容是可以容忍不一致的，飞机大战中，满屏的子弹是由机器控制的，加上子弹本身存在的时间也很短，所以这些子弹在不同的客户端上是可以不一致的；又比如几个玩家一起打电脑控制的怪物，玩家关心的是怪物被打死，而不会太在意其他玩家的出招是不是在自己电脑上滞后了几秒。这种情况下，就可以把可以容忍不一致的那部分游戏逻辑，从网络帧的UpdateByNet拿出到本地渲染帧的Update里。这样就算网络有些卡，但还是有很多东西是不会卡住的（与玩家有关的逻辑更新还是应该受网络帧驱动，不然就失去了同步的效果）。</li>
<li><p>牺牲<strong>实时性</strong>来交换流畅度。一般我们是希望玩家有输入后，从客户端把操作数据发出去，然后在收到下一个网络帧时就能立即得到响应。但是网络是不稳定的，什么时候能收到下一个网络帧是不确定的，如果网络快点，客户端响应得就快，网络慢点，客户端响应得就慢，这会造成同样的操作出现一会快一会慢的效果，像在跑酷游戏中，如果主角一会向前跑得蜗牛似的，一会又向前跑得很快，这是很诡异的。解决办法就是：<strong>收到网络帧数据包后，并不立即响应和处理，而是放入客户端的网络帧缓冲区内，客户端每隔一定时间从缓冲区中取出一个网络帧进行运算</strong>。当网络速度快时，会有比较多的网络帧被存放到缓冲区中，网络速度慢时，可能一段时间内都没有网络帧进入缓冲区，但是客户端依旧可以从缓冲区中取出网络帧（这些网络帧是在网络快时被缓存下来的），因为客户端从缓冲区取网络帧的频率是固定的，所以对数据的运算是匀速的，对游戏逻辑的更新也就匀速了。虽然在网络快时没有得到立即响应，牺牲了实时性，但是同时却换来了游戏的流畅性，平滑了对那些一会快一会慢的网络帧数据包的响应（其实原理类似于传输语音业务，可参考<a href="http://www.w2bc.com/Article/60507" target="_blank" rel="external">这篇文章</a>）。</p>
<p>这种做法会让玩家感觉到一个固定的延迟：输入操作后，隔一定时间才会有反应。但起码这种延迟是可以固定的，是玩家可以预测的，方便玩家操作。（这个操作的感觉就好像玩家有了一定的”惯性”一样，按下跑并不会立刻跑，松开跑不会立刻停，但这个惯性的时间是固定的）</p>
</li>
<li><p>牺牲<strong>公平性</strong>来交换流畅度。这个特性和一致性的根源一致，玩家不希望对方因为网络好，电脑运行速度快就比自己先看到游戏的运行结果，比如在格斗对打游戏和RTS游戏里这是很不公平的。为了让网络、硬件不同的玩家能够公平游戏，经常会使用一种叫”锁步”的策略：每个客户端都定时（每N个渲染帧）发送一个网络帧到服务器，即使玩家没有任何操作也像心跳一样发送空数据帧，每个客户端要收到其他所有客户端的心跳帧才能开始一次逻辑运算和更新。这就是让所有客户端相互等待，如果有玩家卡了，其它客户端都能知道，然后让玩家停止输入来等待对方玩家恢复网络。</p>
<p>这种做法其实是牺牲流畅度的，一旦有玩家掉线了，其他所有玩家都会受到影响。为了减少这种对流畅度的影响，锁步的时候可以少锁一点，对方的”心跳帧”缺了若干帧（比如几秒）自己这里都还是能正常更新，能不公平地玩一会，如果这段时间内还是没有补齐所缺的”心跳帧”，才宣布锁住游戏等待对方玩家恢复网络。这就是通过牺牲公平性来叫交换流畅度。甚至在一些非PVP（玩家对战）的帧同步游戏中都不太需要这个公平性，因为不是和对方玩家实时对战的，并不关注对方是不是比自己先看到结果。</p>
</li>
</ul>
</li>
</ul>
<hr>
<p><font size="5" color="orange">移动网络帧同步中自定义的UDP</font></p>
<ul>
<li><p><font size="4" color="red">为何要使用UDP而不是TCP呢？</font></p>
<ul>
<li>TCP的慢启动算法不适合移动网络，移动网络信号时好时坏，使用慢启动会使数据包的发送速率经常在很低的段位，导致数据不能及时快速地到达对端</li>
<li>拥塞避免算法不适合移动网络主要原因是其考虑到网络的公平性及收敛性，并且AIMD 算法会使实时性大受影响，延迟明显提升</li>
<li>还有TCP协议用于重传的RTO的指数变化及拥塞算法的实现Nagle的缓存等，都是TCP并不太适合高实时性要求的游戏玩法的原因</li>
<li>实验表明，在弱网络环境下，UDP的RTT几乎不受影响，而TCP的RTT波动比较大，特别是受丢包率影响比较明显</li>
</ul>
</li>
<li><p><font size="4" color="red">基于UDP的FSP协议栈</font><br>由于UDP是不可靠的，所以需要DIY自己的UDP。于是基于UDP实现一个自定义的协议栈，称为FSP（FrameSyncProtocol）。<br>FSP的基本原理其实就是仿照TCP的ACK/SEQ重传机制，并且使用冗余重传，来实现传输的可靠性。使用冗余重传的好处是简化了麻烦的时序问题，并且收到的每个包都是顺序的。在网络拥塞时带宽利用率优于TCP，但流量会略微增加一些（好像也无法调节网络拥塞，因为它去除了TCP的拥塞控制机制，可能对于时好时坏的移动网络是比较适合的，因为网络不大会一直很差）。FSP图示如下：<br><img src="http://cfwjm.img48.wal8.com/img48/559974_20161023165829/147721530516.png" alt=""></p>
<ol>
<li>客户端发Action1，服务器未收到</li>
<li>客户端新增Action2，发送给服务器的包同时包含Action1和Action2，并且seq=2</li>
<li>服务器确认并发送给客户端ACK=2的包</li>
<li>客户端由于某些原因（可能是网络延迟）未收到服务器ACK=2的确认包，新增Action3后，客户端则把Action1、Action2、Action3一起发送给服务器，并且seq=3</li>
<li>客户端收到了ACK=2的确认包，则把队列中的Action1、Action2删除，新增Action4后，把队列中的Action3、Action4一起发送给服务器，并且seq=4</li>
</ol>
<p>实际上线测试中，FSP在弱网络环境下表现也是不错的</p>
</li>
</ul>
<hr>
<p>更多详细介绍，请看<a href="http://gad.qq.com/article/detail/7169916" target="_blank" rel="external">这篇文章</a></p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2016/09/18/帧同步/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2016/09/18/帧同步/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2019总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
