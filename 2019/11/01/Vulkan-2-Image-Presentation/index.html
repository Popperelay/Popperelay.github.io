<!DOCTYPE HTML>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
	<link rel="bookmark" type="image/x-icon" href="/img/logo_miccall.png">
	 <link rel="shortcut icon" href="/img/logo_miccall.png">
	
			
    <title>
    Elays'Blog
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<script>
	(function(){
		if('{{ page.password }}'){
			if (prompt('请输入博客密码') !== "elayRender"){
				alert('密码错误！');
				window.location.href='http://www.google.com'
				window.open('','_top'); 
				window.top.close(); 
				window.opener=null; 
				window.close();
			}
		}
	})();
	</script>
    <link rel="stylesheet" href="/css/mic_main.css">
    <link rel="stylesheet" href="/css/dropdownMenu.css">
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
			    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    
		
<!-- Layouts -->


<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
</script>

<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_undefined.css">
<link rel="stylesheet" href="/css/typo.css">
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">Elay</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
            <ul class="menu links">
			<!-- Homepage  主页  --> 
			<li>
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/C/">C#</a></li><li><a class="category-link" href="/categories/C-语法/">C#语法</a></li><li><a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/C语言/">C语言</a></li><li><a class="category-link" href="/categories/Graphics/">Graphics</a></li><li><a class="category-link" href="/categories/Math/">Math</a></li><li><a class="category-link" href="/categories/OpenGL/">OpenGL</a></li><li><a class="category-link" href="/categories/Unity/">Unity</a></li><li><a class="category-link" href="/categories/Vulkan/">Vulkan</a></li><li><a class="category-link" href="/categories/博客配置/">博客配置</a></li><li><a class="category-link" href="/categories/并行计算/">并行计算</a></li><li><a class="category-link" href="/categories/操作系统/">操作系统</a></li><li><a class="category-link" href="/categories/数据结构/">数据结构</a></li><li><a class="category-link" href="/categories/毕设/">毕设</a></li><li><a class="category-link" href="/categories/游戏开发/">游戏开发</a></li><li><a class="category-link" href="/categories/计算机系统/">计算机系统</a></li><li><a class="category-link" href="/categories/设计模式/">设计模式</a>
	                    </li></ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		                <li><a href="null" class="icon fa-github"><span class="label">GitHub</span></a></li>
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img" style="height: 25rem;background-image: url(https://github.com/Popperelay/Photos/blob/master/Photos/VulkanCookbook_2_BG.jpg?raw=true);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2>Vulkan 2 Image Presentation</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
				<!-- 目录 -->
				<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:none">
				<span class="btn-bg"></span>
				<span class="btn-text">文章导航</span>
				</p>
				<div id="toc-article" class="toc-article">
					<span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">×</span>
					<strong class="toc-title">文章目录</strong>
					<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#创建显示表面"><span class="toc-text">创建显示表面</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建启用WSI扩展的Vulkan实例"><span class="toc-text">创建启用WSI扩展的Vulkan实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建显示表面-1"><span class="toc-text">创建显示表面</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取支持显示表面的队列族"><span class="toc-text">获取支持显示表面的队列族</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建启用交换链扩展的逻辑设备"><span class="toc-text">创建启用交换链扩展的逻辑设备</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择显示模式"><span class="toc-text">选择显示模式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取显示表面支持的参数范围"><span class="toc-text">获取显示表面支持的参数范围</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择交换链图像的数量"><span class="toc-text">选择交换链图像的数量</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择交换链图像的尺寸"><span class="toc-text">选择交换链图像的尺寸</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择交换链图像将要被使用的方式"><span class="toc-text">选择交换链图像将要被使用的方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择交换链图像的转换方式"><span class="toc-text">选择交换链图像的转换方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#选择交换链图像的格式"><span class="toc-text">选择交换链图像的格式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建交换链"><span class="toc-text">创建交换链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取交换链图像的句柄"><span class="toc-text">获取交换链图像的句柄</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链"><span class="toc-text">创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#获取可用的交换链图像"><span class="toc-text">获取可用的交换链图像</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#显示图像"><span class="toc-text">显示图像</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#销毁交换链"><span class="toc-text">销毁交换链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#销毁显示表面"><span class="toc-text">销毁显示表面</span></a></li></ol>
			   </div>
			   <script type="text/javascript">
				function showToc(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:block");
					show_toc_btn.setAttribute("style","display:none");
					};
				function showBtn(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:none");
					show_toc_btn.setAttribute("style","display:block");
					};
			   </script>
				
                <p>Vulkan内核并没有提供把图像显示到屏幕上的功能，因为不同操作系统显示图像的方式差别相当大，而如今又没有统一的图像显示标准，所以Vulkan内核为了保持它的跨平台性，就没有在加入这部分功能。所以就需要通过扩展来实现这些功能。和窗口显示图像相关的扩展通常被称为WSI（Windowing System Integration）。</p>
<h1 id="创建显示表面"><a href="#创建显示表面" class="headerlink" title="创建显示表面"></a><font size="6" color="orange">创建显示表面</font></h1><hr>
<p>为了在屏幕上显示图像，我们需要开启一组WSI扩展。它们既有实例级的扩展，也有设备级的扩展。首先我们要创建一个可以让我们创建显示表面（presentation surface，其实就是窗口在Vulkan里的一种跨平台的存在形式）的Vulkan实例。</p>
<h2 id="创建启用WSI扩展的Vulkan实例"><a href="#创建启用WSI扩展的Vulkan实例" class="headerlink" title="创建启用WSI扩展的Vulkan实例"></a><font size="5" color="red">创建启用WSI扩展的Vulkan实例</font></h2><hr>
<p>WSI的实例级扩展是负责管理、创建和销毁显示表面的。显示表面是直接关联到我们的应用程序窗口的，它的创建和具体的操作系统相关，在不同的操作系统上需要通过不同的扩展来创建。在Window上，需要名叫<code>VK_KHR_win32_surface</code>的扩展，在支持X11窗口系统的Linux上，需要名叫<code>VK_KHR_xlib_surface</code>的扩展，在支持XCB窗口系统的Linux上，需要名叫<code>VK_KHR_xcb_surface</code>的扩展。所以我们需要在创建Vulkan实例的时候，根据不同的操作系统，来开启对应的扩展：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">createVulkanInstanceWithWSIExtensionsEnabled</span><span class="token punctuation">(</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> vioDesiredExtensions<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token keyword">const</span> vApplicationName<span class="token punctuation">,</span> VkInstance<span class="token operator">&amp;</span> voInstance<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        vioDesiredExtensions<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>VK_KHR_SURFACE_EXTENSION_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vioDesiredExtensions<span class="token punctuation">.</span><span class="token function">emplace_back</span>
        <span class="token punctuation">(</span>
            <span class="token macro property">#<span class="token directive keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span>
            VK_KHR_WIN32_SURFACE_EXTENSION_NAME
            <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span>
            VK_KHR_XCB_SURFACE_EXTENSION_NAME
            <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span>
            VK_KHR_XLIB_SURFACE_EXTENSION_NAME
            <span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">createVulkanInstance</span><span class="token punctuation">(</span>vioDesiredExtensions<span class="token punctuation">,</span> vApplicationName<span class="token punctuation">,</span> voInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="创建显示表面-1"><a href="#创建显示表面-1" class="headerlink" title="创建显示表面"></a><font size="5" color="red">创建显示表面</font></h2><p>显示表面（presentation surface）就是应用程序的窗口，我们可以通过它来获取窗口的参数，比如窗口的尺寸、支持的颜色格式、需要的图片数量、显示模式（比如垂直同步等等），并且能够让我们检查指定物理设备是否能够把图像显示到指定窗口上。总之，显示表面能帮我们选择出满足我们需求的物理设备。</p>
<p>首先我们自定一个结构体来存储不同操作系统（和窗口系统）下的窗口实例和窗口句柄：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> WindowParameters 
<span class="token punctuation">{</span>
    <span class="token macro property">#<span class="token directive keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span>
    HINSTANCE          HInstance<span class="token punctuation">;</span>
    HWND               HWnd<span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span>
    Display          <span class="token operator">*</span> Dpy<span class="token punctuation">;</span>
    Window             Window<span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span>
    xcb_connection_t <span class="token operator">*</span> Connection<span class="token punctuation">;</span>
    xcb_window_t       Window<span class="token punctuation">;</span>
    <span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后我们使用这个结构体的成员来填充另一个Vulkan结构体<code>VkWin32SurfaceCreateInfoKHR</code>的成员，最后根据不同的平台，调用不同的函数来创建显示表面：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">createPresentationSurface</span><span class="token punctuation">(</span>VkInstance vInstance<span class="token punctuation">,</span> WindowParameters vWindowParameters<span class="token punctuation">,</span> VkSurfaceKHR<span class="token operator">&amp;</span> voPresentationSurface<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkResult Result<span class="token punctuation">;</span>

        <span class="token macro property">#<span class="token directive keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span>
        VkWin32SurfaceCreateInfoKHR SurfaceCreateInfo <span class="token operator">=</span> 
        <span class="token punctuation">{</span>
            VK_STRUCTURE_TYPE_WIN32_SURFACE_CREATE_INFO_KHR<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// VkStructureType                 sType</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                          <span class="token comment" spellcheck="true">// const void                    * pNext</span>
            <span class="token number">0</span><span class="token punctuation">,</span>                                                <span class="token comment" spellcheck="true">// VkWin32SurfaceCreateFlagsKHR    flags</span>
            vWindowParameters<span class="token punctuation">.</span>HInstance<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// HINSTANCE                       hinstance</span>
            vWindowParameters<span class="token punctuation">.</span>HWnd                            <span class="token comment" spellcheck="true">// HWND                            hwnd</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkCreateWin32SurfaceKHR</span><span class="token punctuation">(</span>vInstance<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SurfaceCreateInfo<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voPresentationSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span>
        VkXlibSurfaceCreateInfoKHR SurfaceCreateInfo <span class="token operator">=</span> 
        <span class="token punctuation">{</span>
            VK_STRUCTURE_TYPE_XLIB_SURFACE_CREATE_INFO_KHR<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// VkStructureType                 sType</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                          <span class="token comment" spellcheck="true">// const void                    * pNext</span>
            <span class="token number">0</span><span class="token punctuation">,</span>                                                <span class="token comment" spellcheck="true">// VkXlibSurfaceCreateFlagsKHR     flags</span>
            vWindowParameters<span class="token punctuation">.</span>Dpy<span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">// Display                       * dpy</span>
            vWindowParameters<span class="token punctuation">.</span>Window                          <span class="token comment" spellcheck="true">// Window                          window</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkCreateXlibSurfaceKHR</span><span class="token punctuation">(</span>vInstance<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SurfaceCreateInfo<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voPresentationSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token macro property">#<span class="token directive keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span>
        VkXcbSurfaceCreateInfoKHR SurfaceCreateInfo <span class="token operator">=</span> 
        <span class="token punctuation">{</span>
            VK_STRUCTURE_TYPE_XCB_SURFACE_CREATE_INFO_KHR<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// VkStructureType                 sType</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                          <span class="token comment" spellcheck="true">// const void                    * pNext</span>
            <span class="token number">0</span><span class="token punctuation">,</span>                                                <span class="token comment" spellcheck="true">// VkXcbSurfaceCreateFlagsKHR      flags</span>
            vWindowParameters<span class="token punctuation">.</span>Connection<span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">// xcb_connection_t              * connection</span>
            vWindowParameters<span class="token punctuation">.</span>Window                          <span class="token comment" spellcheck="true">// xcb_window_t                    window</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        Result <span class="token operator">=</span> <span class="token function">vkCreateXcbSurfaceKHR</span><span class="token punctuation">(</span>vInstance<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SurfaceCreateInfo<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voPresentationSurface<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>VK_NULL_HANDLE <span class="token operator">==</span> voPresentationSurface<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not create presentation surface."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="获取支持显示表面的队列族"><a href="#获取支持显示表面的队列族" class="headerlink" title="获取支持显示表面的队列族"></a><font size="6" color="orange">获取支持显示表面的队列族</font></h1><hr>
<p>在屏幕上显示图像的操作命令，不是每一个队列都支持的。所以，我们需要先获取这种队列族：能够支持把图像显示到我们之前创建的显示表面上的队列族。</p>
<p>首先我们获取出指定物理设备上可用的队列族及其属性：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkQueueFamilyProperties<span class="token operator">></span> QueueFamilies<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAvailableQueueFamiliesAndTheirProperties</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> QueueFamilies<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后我们循环这些可用的队列族，通过函数<code>vkGetPhysicalDeviceSurfaceSupportKHR</code>来检查队列族是否支持把图像显示到指定的显示表面上（队列族如果支持显示表面的话，那么队列族里的所有队列也都是支持图像显示的）：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t Index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> Index <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>QueueFamilies<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>Index<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    VkBool32 PresentationSupported <span class="token operator">=</span> VK_FALSE<span class="token punctuation">;</span>
    VkResult Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfaceSupportKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> Index<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PresentationSupported<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">==</span> Result<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>VK_TRUE <span class="token operator">==</span> PresentationSupported<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        voQueueFamilyIndex <span class="token operator">=</span> Index<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取支持显示表面的队列族的函数的完整代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">selectQueueFamilyThatSupportsPresentationToGivenSurface</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPresentationSurface<span class="token punctuation">,</span> uint32_t<span class="token operator">&amp;</span> voQueueFamilyIndex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkQueueFamilyProperties<span class="token operator">></span> QueueFamilies<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkAvailableQueueFamiliesAndTheirProperties</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> QueueFamilies<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>uint32_t Index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> Index <span class="token operator">&lt;</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>QueueFamilies<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>Index<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            VkBool32 PresentationSupported <span class="token operator">=</span> VK_FALSE<span class="token punctuation">;</span>
            VkResult Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfaceSupportKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> Index<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PresentationSupported<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">==</span> Result<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>VK_TRUE <span class="token operator">==</span> PresentationSupported<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                voQueueFamilyIndex <span class="token operator">=</span> Index<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="创建启用交换链扩展的逻辑设备"><a href="#创建启用交换链扩展的逻辑设备" class="headerlink" title="创建启用交换链扩展的逻辑设备"></a><font size="6" color="orange">创建启用交换链扩展的逻辑设备</font></h1><hr>
<p>当我们创建了启用实例级WSI扩展的Vulkan实例，并且获取到了支持图像显示的队列族以后，我们就可以接着去创建启用设备级WSI扩展的逻辑设备了。这样我们就可以在逻辑设备上来创建交换链（swapchain）了。交换链是由显示引擎（presentation engine）管理的图像集合。为了创建交换链，并使用交换链里的图像，往里面渲染东西，我们需要先创建一个启用了交换链扩展的逻辑设备。</p>
<p>交换链会有一堆和OpenGL texture类似的参数，比如我们想要渲染的图像格式、图像数量、显示模式（是否开启垂直同步）。交换链里的图像受显示引擎统一管理，我们不能在交换链之外单独创建和销毁图像。如果我们想要在屏幕上显示一张图像，我们需要先申请一张交换链图像，然后往这个图像里渲染东西，再把图像交还给显示引擎，让显示引擎把图像显示到屏幕上。而这些功能都被定义在交换链扩展<code>VK_KHR_swapchain</code>里。</p>
<p>我们可以在创建逻辑设备时开启交换链扩展：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">createLogicalDeviceWithWSIExtensionsEnabled</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>SQueueInfo<span class="token operator">></span> vQueueInfos<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">></span><span class="token operator">&amp;</span> vioDesiredExtensions<span class="token punctuation">,</span> VkPhysicalDeviceFeatures<span class="token operator">*</span> vDesiredFeatures<span class="token punctuation">,</span> VkDevice<span class="token operator">&amp;</span> voLogicalDevice<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        vioDesiredExtensions<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>VK_KHR_SWAPCHAIN_EXTENSION_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">createLogicalDevice</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vQueueInfos<span class="token punctuation">,</span> vioDesiredExtensions<span class="token punctuation">,</span> vDesiredFeatures<span class="token punctuation">,</span> voLogicalDevice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="选择显示模式"><a href="#选择显示模式" class="headerlink" title="选择显示模式"></a><font size="6" color="orange">选择显示模式</font></h1><hr>
<p>把图像显示到屏幕上是交换链最重要的特性。在OpenGL里，我们只是把图像渲染到后缓冲，然后和前缓冲交换，来把图像显示到屏幕上，我们能决定的只有是否开启垂直同步。而在Vulkan里面，我们能同时渲染多张图像，而不仅仅是渲染到后缓冲，我们也能够选择除了垂直同步以外的其他显示模式。</p>
<p>显示模式定义了图像应该以哪种方式显示到屏幕上。目前，Vulkan有以下四种显示模式：</p>
<ol>
<li>第一种是最简单的IMMEDIATE模式：当图像将要被显示的时候，它会立即替代正在显示的图像，不存在任何等待（等待队列、等待参数）。用这种模式可能会出现图像的撕裂感。该显示模式的示意图如下（没看懂图里显示器为什么会有一个箭头指向显示引擎~）：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/VulkanCookBook_2_1.png?raw=true" alt></li>
<li>第二种是任何Vulkan实现都支持的FIFO模式：当图像将要被显示的时候，它会被加入到一个先入先出队列（队列长度等于交换链里的图像个数-1）。队列里的图像会按照它们被加入的顺序显示到窗口上，并且相邻图像显示之间会有一个消隐时间（blanking periods，其实就是开启垂直同步的效果，让那些帧率太高的应用程序，降到和显示器刷新频率一样，否则对于像赛车这种高速运动的画面，关闭垂直同步之后，会出现上一帧的图像还未显示完，就开始显示下一帧图像，出现画面撕裂）。如下图所示：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/VulkanCookBook_2_2.png?raw=true" alt></li>
<li>第三种是FIFO RELAXED模式：它是在FIFO上稍加改动，说是只在图像帧率高于显示器刷新帧率时才开启垂直同步（难道上一种FIFO模式不是？没看懂）。</li>
<li><p>第四种是MAILBOX模式：队列里只能存一幅图像，说是一个三缓冲的结构，但是没大看懂优点是啥~如下图所示：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/VulkanCookBook_2_3.png?raw=true" alt><br>检查物理设备是否支持我们想要的显示模式的完整代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
 <span class="token keyword">bool</span> <span class="token function">selectDesiredPresentationMode</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPresentationSurface<span class="token punctuation">,</span> VkPresentModeKHR vDesiredPresentMode<span class="token punctuation">,</span> VkPresentModeKHR<span class="token operator">&amp;</span> voPresentMode<span class="token punctuation">)</span>
 <span class="token punctuation">{</span>
     uint32_t PresentModeCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
     VkResult Result <span class="token operator">=</span> VK_SUCCESS<span class="token punctuation">;</span>

     Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfacePresentModesKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PresentModeCount<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> PresentModeCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not get the number of supported present modes."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkPresentModeKHR<span class="token operator">></span> <span class="token function">PresentModes</span><span class="token punctuation">(</span>PresentModeCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
     Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfacePresentModesKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PresentModeCount<span class="token punctuation">,</span> PresentModes<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> PresentModeCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not enumerate present modes."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> CurrentPresentMode <span class="token operator">:</span> PresentModes<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentPresentMode <span class="token operator">==</span> vDesiredPresentMode<span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
             voPresentMode <span class="token operator">=</span> vDesiredPresentMode<span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Desired present mode is not supported. Selecting default FIFO mode."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
     <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> CurrentPresentMode <span class="token operator">:</span> PresentModes<span class="token punctuation">)</span>
     <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentPresentMode <span class="token operator">==</span> VK_PRESENT_MODE_FIFO_KHR<span class="token punctuation">)</span>
         <span class="token punctuation">{</span>
             voPresentMode <span class="token operator">=</span> VK_PRESENT_MODE_FIFO_KHR<span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>

     std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"VK_PRESENT_MODE_FIFO_KHR is not supported though it's mandatory for all drivers!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和之前的查询类似，首先我们两次调用<code>vkGetPhysicalDeviceSurfacePresentModesKHR</code>函数，来获取出指定物理设备支持的所有显示模式，然后遍历这些显示模式，检查我们想要开启的显示模式是否包含在其中，如果是的话就把我们想要开启的显示模式返回给输出变量<code>voPresentMode</code>，否则的话就把FIFO这种显示模式返回出去，因为该模式是所有Vulkan实现都应该支持的，但是为了防止出现意外，最后还是检查了一下物理设备是否支持FIFO模式。</p>
<h1 id="获取显示表面支持的参数范围"><a href="#获取显示表面支持的参数范围" class="headerlink" title="获取显示表面支持的参数范围"></a><font size="6" color="orange">获取显示表面支持的参数范围</font></h1></li>
</ol>
<hr>
<p>在创建交换链的时候，我们可以指定很多诸如图像尺寸、图像个数等等参数，但是这些参数肯定有个范围，我们需要知道显示表面能够支持的最大和最小范围是多少，才能保证成功创建交换链。我们使用下面的代码来获取显示表面支持的参数范围：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">getCapabilitiesOfPresentationSurface</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPresentationSurface<span class="token punctuation">,</span> VkSurfaceCapabilitiesKHR<span class="token operator">&amp;</span> voSurfaceCapabilities<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkResult Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfaceCapabilitiesKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>voSurfaceCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not get the capabilities of a presentation surface."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接使用函数<code>vkGetPhysicalDeviceSurfaceCapabilitiesKHR</code>就可以把现实表面支持的参数范围保存到<code>VkSurfaceCapabilitiesKHR</code>类型的结构体里。该结构体里定义了如下这些成员变量：</p>
<ul>
<li>交换链里最小和最大的图像数量</li>
<li>显示表面（图像）最小、最大以及当前的尺寸</li>
<li>支持的图像转换类型（在显示之前可能会执行图像转换），以及当前正在使用的图像转换类型</li>
<li>支持的最大图像层数（number of layers）</li>
<li>Supported usages（不知道是个啥）</li>
<li>A list of the supported compositions of a surface’s alpha value (how an image’s alpha component should affect the application’s window desktop composition)（没看懂，猜可能是alpha通道对图像的影响）</li>
</ul>
<h1 id="选择交换链图像的数量"><a href="#选择交换链图像的数量" class="headerlink" title="选择交换链图像的数量"></a><fonts size="6" color="orange">选择交换链图像的数量</fonts></h1><hr>
<p>我们可以在应用程序里，从显示引擎中获取出多张图像，但是要保证获取的图像数量不能超过显示表面允许的最大数量。代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">selectNumberOfSwapchainImage</span><span class="token punctuation">(</span>VkSurfaceCapabilitiesKHR <span class="token keyword">const</span><span class="token operator">&amp;</span> vSurfaceCapabilities<span class="token punctuation">,</span> uint32_t<span class="token operator">&amp;</span> voNumberOfImages<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        voNumberOfImages <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>minImageCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vSurfaceCapabilities<span class="token punctuation">.</span>maxImageCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>voNumberOfImages <span class="token operator">></span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
            voNumberOfImages <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageCount<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面代码选择的交换链图像数量是交换链里最小图像数量加1，如果超出了允许的最大图像数量，就截断为最大图像数量。</p>
<h1 id="选择交换链图像的尺寸"><a href="#选择交换链图像的尺寸" class="headerlink" title="选择交换链图像的尺寸"></a><font size="6" color="orange">选择交换链图像的尺寸</font></h1><hr>
<p>通常交换链图像的尺寸都刚好等于窗口的尺寸，但是有的操作系统的窗口大小会取决于显示表面支持的最大图像尺寸（这种情况下显示表面的图像的尺寸会是-1）。选择交换链图像尺寸的代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">chooseSizeOfSwapchainImages</span><span class="token punctuation">(</span>VkSurfaceCapabilitiesKHR <span class="token keyword">const</span><span class="token operator">&amp;</span> vSurfaceCapabilities<span class="token punctuation">,</span> VkExtent2D<span class="token operator">&amp;</span> voSizeOfImages<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0xFFFFFFFF</span> <span class="token operator">==</span> vSurfaceCapabilities<span class="token punctuation">.</span>currentExtent<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            voSizeOfImages <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">640</span><span class="token punctuation">,</span><span class="token number">480</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>voSizeOfImages<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> vSurfaceCapabilities<span class="token punctuation">.</span>minImageExtent<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
                voSizeOfImages<span class="token punctuation">.</span>width <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>minImageExtent<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>voSizeOfImages<span class="token punctuation">.</span>width <span class="token operator">></span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageExtent<span class="token punctuation">.</span>width<span class="token punctuation">)</span>
                voSizeOfImages<span class="token punctuation">.</span>width <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageExtent<span class="token punctuation">.</span>width<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>voSizeOfImages<span class="token punctuation">.</span>height <span class="token operator">&lt;</span> vSurfaceCapabilities<span class="token punctuation">.</span>minImageExtent<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
                voSizeOfImages<span class="token punctuation">.</span>height <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>minImageExtent<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>voSizeOfImages<span class="token punctuation">.</span>height <span class="token operator">></span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageExtent<span class="token punctuation">.</span>height<span class="token punctuation">)</span>
                voSizeOfImages<span class="token punctuation">.</span>height <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>maxImageExtent<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            voSizeOfImages <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>currentExtent<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果显示表面里目前的尺寸是-1（0xFFFFFFFF），说明图像的大小不能由窗口大小来定，那么我们就给图像尺寸赋值一个我们想要的尺寸（这里是{640,480}），然后需要确保这个尺寸没有超过显示表面允许的范围。如果不是-1的话，那就说明图像的尺寸可以直接等于显示表面里的尺寸大小（图像尺寸由窗口大小来定）。</p>
<h1 id="选择交换链图像将要被使用的方式"><a href="#选择交换链图像将要被使用的方式" class="headerlink" title="选择交换链图像将要被使用的方式"></a><font size="6" color="orange">选择交换链图像将要被使用的方式</font></h1><hr>
<p>通过交换链创建的图像通常被用作颜色附件，即我们想要渲染一些东西到图像里（把这些图像作为render target）。但是不仅限于此，我们还可以对交换链图像进行采样、把它们作为拷贝操作的数据源、或者把数据拷贝到它们里面等等。我们可以在创建交换链的时候，来指定这些图像的用途。只是我们又需要先检查显示表面是不是支持这些图像用途了：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">selectDesiredUsageSenariosOfSwapchainImages</span><span class="token punctuation">(</span>VkSurfaceCapabilitiesKHR <span class="token keyword">const</span><span class="token operator">&amp;</span> vSurfaceCapabilies<span class="token punctuation">,</span> VkImageUsageFlags vDesiredUsage<span class="token punctuation">,</span> VkImageUsageFlags<span class="token operator">&amp;</span> voImageUsage<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        voImageUsage <span class="token operator">=</span> vDesiredUsage <span class="token operator">&amp;</span> vSurfaceCapabilies<span class="token punctuation">.</span>supportedUsageFlags<span class="token punctuation">;</span>
        <span class="token keyword">return</span> vDesiredUsage <span class="token operator">==</span> voImageUsage<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们可以从现实表面特性结构体<code>VkSurfaceCapabilitiesKHR</code>的成员变量<code>supportedUsageFlags</code>获取到显示表面支持的图像使用方式有哪些，它是一个位域变量，每个位都对应一种用途。然后将它与我们想要的用途（位域变量<code>vDesiredUsage</code>）进行与操作，来判断显示表面是否支持我们想要的图像用途。</p>
<h1 id="选择交换链图像的转换方式"><a href="#选择交换链图像的转换方式" class="headerlink" title="选择交换链图像的转换方式"></a><font size="6" color="orange">选择交换链图像的转换方式</font></h1><hr>
<p>在一些设备（尤其是移动设备）上，我们可能想要从不同的方向去观看图像。我们可以在创建交换链时，指定图像的转换方式（然后转换后的图像才被显示到屏幕上）。和之前选择图像用途的过程类似，我们把结构体<code>VkSurfaceCapabilitiesKHR</code>的位域成员变量<code>supportedTransforms</code>和我们想要的转换方式进行与操作，如果显示表面支持的话，就返回我们想要的图像转换方式，否则返回显示表面目前的图像转换方式：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">selectTransformationOfSwapchainImage</span><span class="token punctuation">(</span>VkSurfaceCapabilitiesKHR <span class="token keyword">const</span><span class="token operator">&amp;</span> vSurfaceCapabilities<span class="token punctuation">,</span> VkSurfaceTransformFlagBitsKHR vDesiredTranform<span class="token punctuation">,</span> VkSurfaceTransformFlagBitsKHR<span class="token operator">&amp;</span> voSurfaceTransform<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vSurfaceCapabilities<span class="token punctuation">.</span>supportedTransforms <span class="token operator">&amp;</span> vDesiredTranform<span class="token punctuation">)</span>
            voSurfaceTransform <span class="token operator">=</span> vDesiredTranform<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            voSurfaceTransform <span class="token operator">=</span> vSurfaceCapabilities<span class="token punctuation">.</span>currentTransform<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="选择交换链图像的格式"><a href="#选择交换链图像的格式" class="headerlink" title="选择交换链图像的格式"></a><font size="6" color="orange">选择交换链图像的格式</font></h1><hr>
<p>图像格式包括：颜色的通道个数、每个通道的位数以及使用的数据类型、色彩空间等等。我们在创建交换链时，需要指定图像的格式。当然，和其他显示表面参数一样，我们也需要确定显示表面是不是支持我们指定的图像格式：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">selectFormatOfSwapchainImages</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPresentationSurface<span class="token punctuation">,</span> VkSurfaceFormatKHR vDesiredSurfaceFormat<span class="token punctuation">,</span> VkFormat<span class="token operator">&amp;</span> voImageFormat<span class="token punctuation">,</span> VkColorSpaceKHR<span class="token operator">&amp;</span> voImageColorSpace<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint32_t FormatsCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        VkResult Result <span class="token operator">=</span> VK_SUCCESS<span class="token punctuation">;</span>

        Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfaceFormatsKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FormatsCount<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> FormatsCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not get the number of supported surface formats."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkSurfaceFormatKHR<span class="token operator">></span> <span class="token function">SurfaceFormats</span><span class="token punctuation">(</span>FormatsCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkGetPhysicalDeviceSurfaceFormatsKHR</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPresentationSurface<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FormatsCount<span class="token punctuation">,</span> SurfaceFormats<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> FormatsCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not enumerate supported surface formats."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> SurfaceFormats<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>VK_FORMAT_UNDEFINED <span class="token operator">==</span> SurfaceFormats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>format<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            voImageFormat <span class="token operator">=</span> vDesiredSurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">;</span>
            voImageColorSpace <span class="token operator">=</span> vDesiredSurfaceFormat<span class="token punctuation">.</span>colorSpace<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> SurfaceFormat <span class="token operator">:</span> SurfaceFormats<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>vDesiredSurfaceFormat<span class="token punctuation">.</span>format <span class="token operator">==</span> SurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>vDesiredSurfaceFormat<span class="token punctuation">.</span>colorSpace <span class="token operator">==</span> SurfaceFormat<span class="token punctuation">.</span>colorSpace<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                voImageFormat <span class="token operator">=</span> vDesiredSurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">;</span>
                voImageColorSpace <span class="token operator">=</span> vDesiredSurfaceFormat<span class="token punctuation">.</span>colorSpace<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> SurfaceFormat <span class="token operator">:</span> SurfaceFormats<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>vDesiredSurfaceFormat<span class="token punctuation">.</span>format <span class="token operator">==</span> SurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                voImageFormat <span class="token operator">=</span> vDesiredSurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">;</span>
                voImageColorSpace <span class="token operator">=</span> SurfaceFormat<span class="token punctuation">.</span>colorSpace<span class="token punctuation">;</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Desired combination of format and colorspace is not supported. Selecting other colorspace."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        voImageFormat <span class="token operator">=</span> SurfaceFormats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>format<span class="token punctuation">;</span>
        voImageColorSpace <span class="token operator">=</span> SurfaceFormats<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>colorSpace<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Desired format is not supported. Selecting available format - colorspace combination."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先我们两次调用<code>vkGetPhysicalDeviceSurfaceFormatsKHR</code>函数，来获取硬件和显示表面支持的图像格式，然后我们遍历支持的每一种图像格式，看是否有满足我们需求的。如果获取的结果数组里面只有一个元素，并且格式是<code>VK_FORMAT_UNDEFINED</code>，说明硬件能够支持所有图像格式，那么我们直接返回我们想要的图像格式和颜色空间；如果不止一个元素的话，我们就去一个一个找看有没有哪个元素同时符合我们想要的图像格式和颜色空间，如果有的话直接返回我们想要的格式和颜色空间；如果只满足格式，不满足颜色空间的话，就返回我们想要的格式，并且返回显示表面在该图像格式下对应的颜色空间，并输出一些log信息；如果格式和颜色空间都不支持，我们直接返回显示表面支持的第一个元素。</p>
<h1 id="创建交换链"><a href="#创建交换链" class="headerlink" title="创建交换链"></a><font size="6" color="orange">创建交换链</font></h1><hr>
<p>当我们选择好了图像数量、图像尺寸、图像格式、图像用途以及显示模式之后，我们就可以创建交换链了：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">createSwapchain</span><span class="token punctuation">(</span>VkDevice vLogicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPresentationSurface<span class="token punctuation">,</span> uint32_t vImageCount<span class="token punctuation">,</span> VkSurfaceFormatKHR vSurfaceFormat<span class="token punctuation">,</span> VkExtent2D vImageSize<span class="token punctuation">,</span> VkImageUsageFlags vImageUsage<span class="token punctuation">,</span> VkSurfaceTransformFlagBitsKHR vSurfaceTransform<span class="token punctuation">,</span> VkPresentModeKHR vPresentMode<span class="token punctuation">,</span> VkSwapchainKHR<span class="token operator">&amp;</span> vioOldSwapchain<span class="token punctuation">,</span> VkSwapchainKHR<span class="token operator">&amp;</span> voSwapchain<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkSwapchainCreateInfoKHR SwapchainCreateInfo <span class="token operator">=</span>
        <span class="token punctuation">{</span>
            VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// VkStructureType                  sType</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                      <span class="token comment" spellcheck="true">// const void                     * pNext</span>
            <span class="token number">0</span><span class="token punctuation">,</span>                                            <span class="token comment" spellcheck="true">// VkSwapchainCreateFlagsKHR        flags</span>
            vPresentationSurface<span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">// VkSurfaceKHR                     surface</span>
            vImageCount<span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">// uint32_t                         minImageCount</span>
            vSurfaceFormat<span class="token punctuation">.</span>format<span class="token punctuation">,</span>                        <span class="token comment" spellcheck="true">// VkFormat                         imageFormat</span>
            vSurfaceFormat<span class="token punctuation">.</span>colorSpace<span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">// VkColorSpaceKHR                  imageColorSpace</span>
            vImageSize<span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">// VkExtent2D                       imageExtent</span>
            <span class="token number">1</span><span class="token punctuation">,</span>                                            <span class="token comment" spellcheck="true">// uint32_t                         imageArrayLayers</span>
            vImageUsage<span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">// VkImageUsageFlags                imageUsage</span>
            VK_SHARING_MODE_EXCLUSIVE<span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">// VkSharingMode                    imageSharingMode</span>
            <span class="token number">0</span><span class="token punctuation">,</span>                                            <span class="token comment" spellcheck="true">// uint32_t                         queueFamilyIndexCount</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                      <span class="token comment" spellcheck="true">// const uint32_t                 * pQueueFamilyIndices</span>
            vSurfaceTransform<span class="token punctuation">,</span>                            <span class="token comment" spellcheck="true">// VkSurfaceTransformFlagBitsKHR    preTransform</span>
            VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// VkCompositeAlphaFlagBitsKHR      compositeAlpha</span>
            vPresentMode<span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">// VkPresentModeKHR                 presentMode</span>
            VK_TRUE<span class="token punctuation">,</span>                                      <span class="token comment" spellcheck="true">// VkBool32                         clipped</span>
            vioOldSwapchain                               <span class="token comment" spellcheck="true">// VkSwapchainKHR                   oldSwapchain</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        VkResult Result <span class="token operator">=</span> <span class="token function">vkCreateSwapchainKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SwapchainCreateInfo<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voSwapchain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>VK_NULL_HANDLE <span class="token operator">==</span> voSwapchain<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not create a swapchain."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>VK_NULL_HANDLE <span class="token operator">!=</span> vioOldSwapchain<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">vkDestroySwapchainKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> vioOldSwapchain<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vioOldSwapchain <span class="token operator">=</span> VK_NULL_HANDLE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先我们用之前选择好的信息来填充<code>VkSwapchainCreateInfoKHR</code>结构体，然后再调用<code>vkCreateSwapchainKHR</code>函数来创建交换链。因为一个窗口只能关联一个交换链，所以我们创建新的交换链之后，需要销毁以前为该窗口创建的交换链。</p>
<p>有了交换链之后，我们就可以从交换链里获取出图像了，并且可以使用这些图像来作为render target等等（前面说过不限于render target）。</p>
<h1 id="获取交换链图像的句柄"><a href="#获取交换链图像的句柄" class="headerlink" title="获取交换链图像的句柄"></a><font size="6" color="orange">获取交换链图像的句柄</font></h1><hr>
<p>交换链创建之后，接下来很有用的一件事是：获取交换链里图像的数量和图像的句柄：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">getHandlesOfSwapchainImages</span><span class="token punctuation">(</span>VkDevice vLogicalDevice<span class="token punctuation">,</span> VkSwapchainKHR vSwapchain<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkImage<span class="token operator">></span><span class="token operator">&amp;</span> voSwapchainImages<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        uint32_t ImageCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        VkResult Result <span class="token operator">=</span> VK_SUCCESS<span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkGetSwapchainImagesKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> vSwapchain<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ImageCount<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ImageCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not get the number of swapchain images."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        voSwapchainImages<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>ImageCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkGetSwapchainImagesKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> vSwapchain<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ImageCount<span class="token punctuation">,</span> voSwapchainImages<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>VK_SUCCESS <span class="token operator">!=</span> Result<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> ImageCount<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not enumerate swapchain images."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和之前的查询方式类似，我们这里两次调用<code>vkGetSwapchainImagesKHR</code>函数来获取交换链中所有图像的句柄。</p>
<h1 id="创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链"><a href="#创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链" class="headerlink" title="创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链"></a><font size="6" color="orange">创建使用R8G8B8A8格式并且使用mailbox显示模式的交换链</font></h1><hr>
<p>下面我们来个完整点的例子，过一下之前的步骤：创建一个使用R8G8B8A8图像格式并且使用mailbox显示模式的交换链：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">createSwapchainWithR8G8B8A8FormatAndMailboxPresentMode</span><span class="token punctuation">(</span>VkPhysicalDevice vPhysicalDevice<span class="token punctuation">,</span> VkSurfaceKHR vPrensentationSurface<span class="token punctuation">,</span> VkDevice vLogicalDevice<span class="token punctuation">,</span> VkImageUsageFlags vSwapchainImageUsage<span class="token punctuation">,</span> VkExtent2D<span class="token operator">&amp;</span> voImageSize<span class="token punctuation">,</span> VkFormat<span class="token operator">&amp;</span> voImageFormat<span class="token punctuation">,</span> VkSwapchainKHR<span class="token operator">&amp;</span> voOldSwapchain<span class="token punctuation">,</span> VkSwapchainKHR<span class="token operator">&amp;</span> voSwapchain<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkImage<span class="token operator">></span><span class="token operator">&amp;</span> voSwapchainImages<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkPresentModeKHR DesiredPresentMode<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectDesiredPresentationMode</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPrensentationSurface<span class="token punctuation">,</span> VK_PRESENT_MODE_MAILBOX_KHR<span class="token punctuation">,</span> DesiredPresentMode<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        VkSurfaceCapabilitiesKHR SurfaceCapabilities<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getCapabilitiesOfPresentationSurface</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPrensentationSurface<span class="token punctuation">,</span> SurfaceCapabilities<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        uint32_t NumberOfImages<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectNumberOfSwapchainImage</span><span class="token punctuation">(</span>SurfaceCapabilities<span class="token punctuation">,</span> NumberOfImages<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">chooseSizeOfSwapchainImages</span><span class="token punctuation">(</span>SurfaceCapabilities<span class="token punctuation">,</span> voImageSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> voImageSize<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> voImageSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        VkImageUsageFlags ImageUsage<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectDesiredUsageSenariosOfSwapchainImages</span><span class="token punctuation">(</span>SurfaceCapabilities<span class="token punctuation">,</span> vSwapchainImageUsage<span class="token punctuation">,</span> ImageUsage<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        VkSurfaceTransformFlagBitsKHR SurfaceTransform<span class="token punctuation">;</span>
        <span class="token function">selectTransformationOfSwapchainImage</span><span class="token punctuation">(</span>SurfaceCapabilities<span class="token punctuation">,</span> VK_SURFACE_TRANSFORM_IDENTITY_BIT_KHR<span class="token punctuation">,</span> SurfaceTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>

        VkColorSpaceKHR ImageColorSpace<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">selectFormatOfSwapchainImages</span><span class="token punctuation">(</span>vPhysicalDevice<span class="token punctuation">,</span> vPrensentationSurface<span class="token punctuation">,</span> <span class="token punctuation">{</span> VK_FORMAT_R8G8B8A8_UNORM<span class="token punctuation">,</span>VK_COLOR_SPACE_SRGB_NONLINEAR_KHR <span class="token punctuation">}</span><span class="token punctuation">,</span> voImageFormat<span class="token punctuation">,</span> ImageColorSpace<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">createSwapchain</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> vPrensentationSurface<span class="token punctuation">,</span> NumberOfImages<span class="token punctuation">,</span> <span class="token punctuation">{</span> voImageFormat<span class="token punctuation">,</span>ImageColorSpace <span class="token punctuation">}</span><span class="token punctuation">,</span> voImageSize<span class="token punctuation">,</span> ImageUsage<span class="token punctuation">,</span> SurfaceTransform<span class="token punctuation">,</span> DesiredPresentMode<span class="token punctuation">,</span> voOldSwapchain<span class="token punctuation">,</span> voSwapchain<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getHandlesOfSwapchainImages</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> voSwapchain<span class="token punctuation">,</span> voSwapchainImages<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>过程很简单，就是一步一步选择显示模式、显示表面特性，再结合显示表面特性来选择交换链里的图像数量、图像尺寸、图像用途、图像显示到屏幕之前的转换方式、图像颜色空间的等等参数，然后根据这些参数来创建交换链，最后获取出交换链里所有图像的句柄。</p>
<h1 id="获取可用的交换链图像"><a href="#获取可用的交换链图像" class="headerlink" title="获取可用的交换链图像"></a><font size="6" color="orange">获取可用的交换链图像</font></h1><hr>
<p>前面我们只是获取到了交换链里所有图像的句柄，把它们存到了一个数组里。但不是这个数组里的所有图像都是可用的，因为有可能交换链里有的图像正在被使用，或者因为其他原因无法被使用。所以我们还需要调用<code>vkAcquireNextImageKHR</code>函数来获取数组中可用的图像的索引。</p>
<p>在这个函数里，会用到信号量（Semaphore）和互斥量（Fence）。在Vulkan里，信号量是用来同步设备队列的。队列里某些命令可能需要等待其他命令执行完，才能正常执行，这时候就需要用信号量来让该命令等待其他命令执行完。但是信号量只能用来同步队列内部的命令，不能用来在应用程序（CPU端）和队列命令（GPU端）之间进行同步。这个时候需要用到互斥量，它用来通知应用程序某些工作已经完成了。应用程序可以通过获取互斥量的状态，来检查某些命令是在执行中还是已经被执行完了。简单来说，信号量实在GPU上使用的，互斥量实在CPU上使用的。</p>
<p>下面来看一下获取可用的交换链图像的完整代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">acquireSwapchainImage</span><span class="token punctuation">(</span>VkDevice vLogicalDevice<span class="token punctuation">,</span> VkSwapchainKHR vSwapchain<span class="token punctuation">,</span> VkSemaphore vSemaphore<span class="token punctuation">,</span> VkFence vFence<span class="token punctuation">,</span> uint32_t<span class="token operator">&amp;</span> voImageIndex<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkResult Result<span class="token punctuation">;</span>
        Result <span class="token operator">=</span> <span class="token function">vkAcquireNextImageKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> vSwapchain<span class="token punctuation">,</span> <span class="token number">2000000000</span><span class="token punctuation">,</span> vSemaphore<span class="token punctuation">,</span> vFence<span class="token punctuation">,</span> <span class="token operator">&amp;</span>voImageIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> VK_SUCCESS<span class="token operator">:</span>
        <span class="token keyword">case</span> VK_SUBOPTIMAL_KHR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面我们调用了函数<code>vkAcquireNextImageKHR</code>。由于现实引擎的内部机制，有时候我们可能无法立即获得图像，甚至有可能让我们无限等待下去（如果我们获取的图像数量超过了现实引擎能够支持的图像数量，就可能发生这个问题）。所以我们在第三个参数里提供了一个纳秒级的timeout，它告诉硬件为了获取图像我们最多能等待多久，这里是2秒。</p>
<p>我们还可能因为之前提交的命令正在访问图像，而无法立即获取到该图像，这个时候我们必须等之前的命令执行完。这时候就需要用到互斥量，让应用程序可以通过互斥量，来检查现在修改图像是否是安全的。而且我们还应该告诉驱动器，在它开始处理和该图像相关的新的命令之前，也应该先等之前的命令执行完，这个时候应该用信号量。</p>
<p>需要注意的是，让CPU端的应用程序等待，会比让GPU端等待更影响性能。</p>
<p>该函数的返回值也很重要，如果返回值是<code>VK_SUBOPTIMAL_KHR</code>，就意味着我们虽然可以继续使用交换链中的图像，但是这种情况对显示引擎不是最好的，我们应该重新创建图像所在的交换链，不过我们不需要立刻来做这件事。但是如果返回值是<code>VK_ERROR_OUT_OF_DATE_KHR</code>，意味着我们不能使用交换链里的图像，应该尽快重建交换链。</p>
<p>在获取交换链图像中，还有另一件事值得注意：在我们使用图像之前，我们需要先改变它的布局（layout）（有点像图像用途或者说OpenGL里面的绑定点）。布局是指图像内存的组织方式，用途不同的时候，图像布局也需要随之改变。比如，给显示引擎用的图像需要有一个<code>VK_IMAGE_LAYOUT_PRESENT_SRC_KHR</code>类型的布局，用来做render target的图像，需要有<code>VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL</code>类型的布局（怎么改变这个布局后面几章会讲）。</p>
<h1 id="显示图像"><a href="#显示图像" class="headerlink" title="显示图像"></a><font size="6" color="orange">显示图像</font></h1><hr>
<p>往交换链图像里渲染好内容以后（这部分先跳过，后面再讲），我们需要把图像交还给显示引擎，显示引擎才能帮我们把图像显示到屏幕上：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">bool</span> <span class="token function">presentImage</span><span class="token punctuation">(</span>VkQueue vQueue<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkSemaphore<span class="token operator">></span> vRenderingSemaphores<span class="token punctuation">,</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>SPresentInfo<span class="token operator">></span> vImagesToPresent<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        VkResult Result<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>VkSwapchainKHR<span class="token operator">></span> Swapchains<span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>uint32_t<span class="token operator">></span> ImageIndices<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> ImageToPresent <span class="token operator">:</span> vImagesToPresent<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Swapchains<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>ImageToPresent<span class="token punctuation">.</span>Swapchain<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ImageIndices<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>ImageToPresent<span class="token punctuation">.</span>ImageIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        VkPresentInfoKHR PresentInfo <span class="token operator">=</span>
        <span class="token punctuation">{</span>
            VK_STRUCTURE_TYPE_PRESENT_INFO_KHR<span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">// VkStructureType          sType</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                                              <span class="token comment" spellcheck="true">// const void*              pNext</span>
            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>vRenderingSemaphores<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// uint32_t                 waitSemaphoreCount</span>
            vRenderingSemaphores<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">// const VkSemaphore      * pWaitSemaphores</span>
            <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint32_t<span class="token operator">></span><span class="token punctuation">(</span>Swapchains<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">// uint32_t                 swapchainCount</span>
            Swapchains<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                    <span class="token comment" spellcheck="true">// const VkSwapchainKHR   * pSwapchains</span>
            ImageIndices<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                  <span class="token comment" spellcheck="true">// const uint32_t         * pImageIndices</span>
            <span class="token keyword">nullptr</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        Result <span class="token operator">=</span> <span class="token function">vkQueuePresentKHR</span><span class="token punctuation">(</span>vQueue<span class="token punctuation">,</span> <span class="token operator">&amp;</span>PresentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Result<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> VK_SUCCESS<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先我们创建了一个结构体<code>SPresentInfo</code>，它用来存储我们想要显示的图像所在的交换链以及在交换链里的图像索引。函数<code>vkQueuePresentKHR</code>用来把<code>PresentInfo</code>里记录的图像返还给显示引擎。其中信号量用来通知硬件什么时候可以安全显示图像。这些信号量是和操作这些图像的命令关联在一起的。当和图像相关的命令执行完之后，硬件就可以通过信号量知道对应的图像可以被安全显示了。</p>
<p>需要注意的是，我们可以在同一时刻显示多张图像，这些图像需要来自不同的交换链，因为同一时刻一个交换链只能提供一张图像。</p>
<h1 id="销毁交换链"><a href="#销毁交换链" class="headerlink" title="销毁交换链"></a><font size="6" color="orange">销毁交换链</font></h1><hr>
<p>不再需要用到交换链时，我们可以调用函数<code>vkDestroySwapchainKHR</code>来销毁交换链：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">destroySwapchain</span><span class="token punctuation">(</span>VkDevice vLogicalDevice<span class="token punctuation">,</span> VkSwapchainKHR<span class="token operator">&amp;</span> voSwapchain<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voSwapchain<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">vkDestroySwapchainKHR</span><span class="token punctuation">(</span>vLogicalDevice<span class="token punctuation">,</span> voSwapchain<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            voSwapchain <span class="token operator">=</span> VK_NULL_HANDLE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h1 id="销毁显示表面"><a href="#销毁显示表面" class="headerlink" title="销毁显示表面"></a><font size="6" color="orange">销毁显示表面</font></h1><hr>
<p>显示表面表示的是我们应用程序的窗口。不再需要用到窗口时可以销毁它，销毁显示表面的过程也是类似的：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">namespace</span> VulkanCookbook
<span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">destroyPresentationSurface</span><span class="token punctuation">(</span>VkInstance vInstance<span class="token punctuation">,</span> VkSurfaceKHR<span class="token operator">&amp;</span> voPresentationSurface<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>voPresentationSurface<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">vkDestroySurfaceKHR</span><span class="token punctuation">(</span>vInstance<span class="token punctuation">,</span> voPresentationSurface<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            voPresentationSurface <span class="token operator">=</span> VK_NULL_HANDLE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/11/01/Vulkan-2-Image-Presentation/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2019/11/01/Vulkan-2-Image-Presentation/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2019总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
