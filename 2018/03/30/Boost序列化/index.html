<!DOCTYPE HTML>
<html>

<head>
	<link rel="bookmark"  type="image/x-icon"  href="/img/logo_miccall.png"/>
	 <link rel="shortcut icon" href="/img/logo_miccall.png">
	
			
    <title>
    Elays'Blog
    </title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/css/mic_main.css" />
    <link rel="stylesheet" href="/css/dropdownMenu.css" />
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css" />
    </noscript>
			    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    
		
<!-- Layouts -->


<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML" async>
</script>

<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_undefined.css" />
<link rel="stylesheet" href="/css/typo.css" />
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">MICCALL</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special" >
            <ul class="menu links" >
			<!-- Homepage  主页  --> 
			<li >
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/Boost/">Boost</a></li><li><a class="category-link" href="/categories/C-语法/">C#语法</a></li><li><a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/C语言/">C语言</a></li><li><a class="category-link" href="/categories/OpenGL/">OpenGL</a></li><li><a class="category-link" href="/categories/c/">c++</a></li><li><a class="category-link" href="/categories/全局光照/">全局光照</a></li><li><a class="category-link" href="/categories/博客配置/">博客配置</a></li><li><a class="category-link" href="/categories/并行计算/">并行计算</a></li><li><a class="category-link" href="/categories/操作系统/">操作系统</a></li><li><a class="category-link" href="/categories/数据结构/">数据结构</a></li><li><a class="category-link" href="/categories/毕设/">毕设</a></li><li><a class="category-link" href="/categories/游戏开发/">游戏开发</a></li><li><a class="category-link" href="/categories/游戏设计模式/">游戏设计模式</a></li><li><a class="category-link" href="/categories/计算机图形学/">计算机图形学</a></li><li><a class="category-link" href="/categories/计算机系统/">计算机系统</a></li><li><a class="category-link" href="/categories/设计模式/">设计模式</a></li><li><a class="category-link" href="/categories/调试错误集锦/">调试错误集锦</a>
	                    </ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        
		        <li>
		            <a href="/gallery/" title="图库">
		                图库
		            </a>
		        </li>
		        
		        <li>
		            <a href="/tag/" title="搜索">
		                搜索
		            </a>
		        </li>
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		                <li><a href="https://github.com/miccall" class="icon fa-github"><span class="label">GitHub</span></a></li>
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main" >
            <div class ="post_page_title_img" style="height: 25rem;background-image: url(http://oqcvzqam1.bkt.clouddn.com/Boost%E5%BA%8F%E5%88%97%E5%8C%96.jpg);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;" >
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2 >Boost序列化</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
				<!-- <div id="toc" class="toc-article"> -->
					<!-- <strong class="toc-title">文章目录</strong> -->
					<!--  -->
				<!-- </div> -->
				
				<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:none">
				<span class="btn-bg"></span>
				<span class="btn-text">文章导航</span>
				</p>
				<div id="toc-article" class="toc-article">
					<span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">×</span>
					<strong class="toc-title">文章目录</strong>
					
			   </div>
			   <script type="text/javascript">
				function showToc(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:block");
					show_toc_btn.setAttribute("style","display:none");
					};
				function showBtn(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:none");
					show_toc_btn.setAttribute("style","display:block");
					};
			   </script>
				
                <p><font size="5" color="orange">概述</font></p>
<hr>
<p>Boost C++的序列化库允许将C++对象转换为一个字节序列（序列化），此序列可以被保存成字符串、文件等等形式，并且可以在需要的时候把字节序列恢复成一个对象（反序列化）。</p>
<p>序列化的主要概念是归档(archive)，就是指把一个对象序列化成字节序列然后反序列化的过程。</p>
<p><font size="5" color="orange">序列化到文件</font></p>
<hr>
<p>Boost可以通过归档类<code>boost::archive::text_oarchive</code>来把对象序列化到文件里（该类定义在boost/archive/text_oarchive.hpp里），然后通过归档类<code>boost::archive::text_iarchive</code>从文件里恢复出对象来：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化归档的构造函数应该关联文件流</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//用Boost的text_oarchive关联输出流（代替输出流来执行序列化写入操作）</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">41</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//用Boost的text_iarchive关联输入流（代替输入流来执行序列化读取操作）</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    IA <span class="token operator">>></span> i<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从上面的程序可以看到，在定义归档类text_oarchive的对象OA，或者text_iarchive的对象IA时，需要同时关联一个文件流对象，然后用这个归档类对象代替文件流对象，来执行文件的写入和读取操作。</p>
<p>在本地生成的文件serialization.txt里，被序列化入如下数据：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token number">22</span> serialization<span class="token operator">::</span>archive <span class="token number">13</span> <span class="token number">41</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>可以看到变量i的值41确实被序列化到文件里了，当然程序使用load函数反序列化后，会把文件里的这个41赋给变量i，然后输出i的值。程序输出当然是41咯！</p>
<p><font size="5" color="orange">序列化到字符串流</font></p>
<hr>
<p>除了序列化到文件流，我们还可以序列化到文件流：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化归档的构造函数关联字符串流</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sstream></span></span>

std<span class="token operator">::</span>stringstream ss<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//用Boost的text_oarchive关联输出流（代替输出流来执行序列化写入操作）</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">41</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//用Boost的text_iarchive关联输入流（代替输入流来执行序列化读取操作）</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    IA <span class="token operator">>></span> i<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>和之前程序不同的只是：关联的是字符串流而不是文件流罢了。</p>
<p><font size="5" color="orange">序列化和反序列化自定义类</font></p>
<hr>
<p>如果想要序列化我们自己定义的类呢？我们可以通过在自定义类中加入serialize模板函数来实现：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化和反序列化自定义类</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//友元访问</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span><span class="token comment" spellcheck="true">//自定义类想要被序列化必须定义serialize函数，为了不区分text_oarchive和text_iarchive所以定义成模板</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_Data<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//&amp;既可以表示&lt;&lt;又可以表示>>，视模板Archive类型而定，这个&amp;的意义在于不用去区分serialize到底是完成序列化还是反序列化了</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//序列化CData类对象到文件中</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//从文件中反序列化到CData类对象中</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了序列化自定义的类，serialize模板函数必须被定义，它在对象被序列化或反序列化时被调用。我们可以使用&amp;操作符来代替&lt;&lt;和&gt;&gt;，这样就不用在serialize函数里区分到底是序列化还是反序列化了。serialize函数应该是私有的，因为它不会再被别的对象调用了，而且需要将boost::serialization::access类声明为友元，这样才能让Boost.Serialization来序列化该类的私有成员。</p>
<p><font size="5" color="orange">把serialize函数拆分为序列化函数save和反序列化函数load</font></p>
<hr>
<p>上面那样把序列化和反序列都用serialize函数来实现是通常的做法，但是如果有时候想要序列化和反序列化执行一些不同的操作呢？当然就不能用同一个函数来实现了：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//把类内的serialize函数拆分为save和load，因为有的时候不想要序列化和反序列化都使用相同的serialize函数内容</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span> <span class="token keyword">const</span>    <span class="token comment" spellcheck="true">//save必须有const，否则无法编译</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&lt;&lt;</span> m_Data <span class="token operator">&lt;&lt;</span> vVersion<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//无const</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">>></span> m_Data<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>vVersion <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
            Ar <span class="token operator">>></span> m_VersionIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">BOOST_SERIALIZATION_SPLIT_MEMBER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> m_VersionIndex <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">BOOST_CLASS_VERSION</span><span class="token punctuation">(</span>CData<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的程序把原来的serialize函数拆分成了save和load函数，来分别实现序列化和反序列化。其中序列化函数save必须有const声明，否则会编译报错，而load函数不需要const。</p>
<p>在load函数中会判断当前归档的版本号，如果当前版本号大于0就反序列化进成员m_VersionIndex中。可以通过<code>BOOST_CLASS_VERSION(CData, 1);</code>来设置当前归档的版本号。</p>
<p><font size="5" color="orange">非侵入式serialize函数</font></p>
<hr>
<p>之前代码里的serialize函数都是侵入式的，即必须在原有类的代码里加入serialize函数，如果不想要去改变原有类的代码怎么办呢？答案是写一个非成员版本的serialize函数，将需要序列化的类对象作为第二个参数传入：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//serialize不作为成员函数</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">friend</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> CData <span class="token operator">&amp;</span>vioData<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> CData <span class="token operator">&amp;</span>vioData<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//CData&amp;</span>
<span class="token punctuation">{</span>
    Ar <span class="token operator">&amp;</span> vioData<span class="token punctuation">.</span>m_Data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Seriliazation.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Seriliazation.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是这种情况下会要求需要序列化的类成员是公有的，才能在外部的serialize函数里通过类对象访问到。这无疑会破坏原有类的封装性。还有一个折中的方案就是在原有类代码中将非成员的serialize函数声明为其友元函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//serialize不作为成员函数，只是友元函数</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">friend</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> CData <span class="token operator">&amp;</span>vioData<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
<span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> CData <span class="token operator">&amp;</span>vioData<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//CData&amp;</span>
<span class="token punctuation">{</span>
    Ar <span class="token operator">&amp;</span> vioData<span class="token punctuation">.</span>m_Data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Seriliazation.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Seriliazation.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是对于C++标准库里的类肯定无法修改其原有代码，连友元都无法增加，不过还好，Boost.Serialization为许多C++标准库的类提供了serialize函数。为了序列化标准库的类，需要添加对应的头文件，比如序列化vector时需要添加boost/serialization/vector.hpp。</p>
<p><font size="5" color="orange">序列化STL中的数据结构</font></p>
<hr>
<p>我们可以通过添加对应的头文件，来序列化STL中的数据结构，比如vector：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化数据中加入STL数据结构</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/serialization/vector.hpp></span>    </span><span class="token comment" spellcheck="true">//string可以不加对应的头文件，vector等还是要的</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string <span class="token operator">&amp;</span>vDataName<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token operator">&amp;</span>vValues<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_DataName</span><span class="token punctuation">(</span>vDataName<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">m_Values</span><span class="token punctuation">(</span>vValues<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> <span class="token function">getDataName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_DataName<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Values<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_Data <span class="token operator">&amp;</span> m_DataName <span class="token operator">&amp;</span> m_Values<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string m_DataName<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> m_Values<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token string">"Jia"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getDataName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> e <span class="token operator">:</span> DataObj<span class="token punctuation">.</span><span class="token function">getValues</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">序列化对象指针或引用</font></p>
<hr>
<p>在save里我们还可以直接序列化对象指针，这个时候序列化的不是指针表示的地址，而不是指针所指向的对象。在load里也可以直接反序列化给一个指针或引用，只不过这时是指向反序列化后一个新创建的对象，该对象的地址与序列化之前的对象地址不同，它们不是一个对象，只是数据内容相同而已：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化对象指针或引用，值得注意的是不能直接序列化基本类型的指针</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_Data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token operator">*</span>pDataObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CData</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> pDataObj<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//序列化的是pDataObj指向的对象，而不是指针</span>
    <span class="token keyword">delete</span> pDataObj<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//int i = 41;        //不能直接序列化基本类型指针，但是可以序列化定义了serialize函数的类类型指针，需要改成OA&lt;&lt; *j;</span>
    <span class="token comment" spellcheck="true">//int *j = &amp;i;        //如果是xml归档，需要改成OA&lt;&lt; boost::serialization::make_nvp("name", *j);而不能使用OA &lt;&lt; BOOST_SERIALIZATION_NVP(*j)</span>
    <span class="token comment" spellcheck="true">//OA &lt;&lt; j;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token operator">*</span>pDataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> pDataObj<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//序列化会新创建一个对象赋给pDataObj（和序列化之前的对象地址不一定相同）</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> pDataObj<span class="token operator">-</span><span class="token operator">></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> pDataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>值得注意的是，我们不能直接序列化一个基本类型的指针，而只能直接序列化定义了serialize函数的类类型指针。对于txt归档，想要序列化基本类型的指针必须用<code>OA&lt;&lt; *j;</code>，而对于xml归档（后续详述）需要用<code>OA&lt;&lt; boost::serialization::make_nvp(&quot;name&quot;, *j);</code>，用<code>OA &lt;&lt; BOOST_SERIALIZATION_NVP(*j);</code>都不行，必须用make_nvp函数。</p>
<p><font size="5" color="orange">序列化智能指针对象</font></p>
<hr>
<p>想要序列化智能指针，必须先包含对应的头文件，比如boost/serialization/shared_ptr.hpp：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化智能指针对象</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/serialization/shared_ptr.hpp></span>    </span><span class="token comment" spellcheck="true">//需要加入序列化智能指针所对应的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_Data<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_Data<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CData<span class="token operator">></span> pDataObj <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>CData<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> pDataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>CData<span class="token operator">></span> pDataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> pDataObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> pDataObj<span class="token operator">-</span><span class="token operator">></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">序列化类内指针</font></p>
<hr>
<p>和序列化基本类型指针一样，如果类内指针也是基本类型的，那么也需要先解指针以后才能进行序列化。而且在序列化和反序列化时，一定要确保对应的指针成员是有效的（即指向有效的内存地址），否则会编译报错：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化类内指针</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> m_pData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//一定要确保指针是有效的</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token punctuation">{</span> m_pData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">*</span>m_pData <span class="token operator">=</span> vData<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">//一定要确保指针是有效的</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">*</span>m_pData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>

    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> <span class="token operator">*</span>m_pData<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//不能直接序列化基本类型指针，需要先解指针</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> <span class="token operator">*</span>m_pData <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DataObj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//一定要确保指针是有效的，否则反序列化时会出错</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> DataObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">直接序列化子类对象</font></p>
<hr>
<p>在序列化子类对象时，父类和子类都要有serialize函数，而且在子类的serialize函数里，需要用<code>Ar &amp; boost::serialization::base_object&lt;CBase&gt;(*this);</code>这句代码，来确保(继承自)基类的属性也能被正确序列化：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化派生类</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CBase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_BaseData</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_BaseData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_BaseData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_BaseData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CDerived</span> <span class="token operator">:</span><span class="token keyword">public</span> CBase
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vBaseData<span class="token punctuation">,</span> <span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">CBase</span><span class="token punctuation">(</span>vBaseData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_DerivedData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span>base_object<span class="token operator">&lt;</span>CBase<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//子类必须在serialize函数中序列化基类，确保继承自基类的属性也能正确地序列化，否则load时</span>
                                                                <span class="token comment" spellcheck="true">//输出的BaseData就是0，而不是41</span>
        Ar <span class="token operator">&amp;</span> m_DerivedData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_DerivedData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CDerived <span class="token function">DerivedObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> DerivedObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CDerived DerivedObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> DerivedObj<span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"DerivedData: "</span> <span class="token operator">&lt;&lt;</span> DerivedObj<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" BaseData: "</span> <span class="token operator">&lt;&lt;</span> DerivedObj<span class="token punctuation">.</span>CBase<span class="token operator">::</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">使用虚基类指针来序列化子类对象（通过宏BOOST_CLASS_EXPORT的方式）</font></p>
<hr>
<p>如果想要通过基类指针来序列化子类对象（子类对象的所有数据成员都被序列化，不仅仅是继承自基类的那些），一种方案是通过宏BOOST_CLASS_EXPORT来显式声明需要被序列化的子类：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//用虚基类指针序列化子类对象（使用BOOST_CLASS_EXPORT方式）</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/serialization/export.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CBase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_BaseData</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_BaseData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_BaseData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_BaseData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CDerived</span> <span class="token operator">:</span><span class="token keyword">public</span> CBase
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vBaseData<span class="token punctuation">,</span> <span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">CBase</span><span class="token punctuation">(</span>vBaseData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_DerivedData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span>base_object<span class="token operator">&lt;</span>CBase<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Ar <span class="token operator">&amp;</span> m_DerivedData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_DerivedData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">BOOST_CLASS_EXPORT</span><span class="token punctuation">(</span>CDerived<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//基类如果不是虚基类这行代码过不了</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CBase <span class="token operator">*</span>pBaseObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> pBaseObj<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> pBaseObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CBase <span class="token operator">*</span>pBaseObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> pBaseObj<span class="token punctuation">;</span>
    CDerived <span class="token operator">*</span>pDerivedObj <span class="token operator">=</span> <span class="token keyword">dynamic_cast</span><span class="token operator">&lt;</span>CDerived<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>pBaseObj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//使用宏BOOST_CLASS_EXPORT的时候必须强制类型转换才可以，而不能直接写成IA>>pDerivedObj（无法进行隐式转换）</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span><span class="token string">"DerivedData: "</span> <span class="token operator">&lt;&lt;</span> pDerivedObj<span class="token operator">-</span><span class="token operator">></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> pDerivedObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>值得注意的是，如果使用的是这种宏定义显式声明子类的方式，在反序列化时必须先反序列化到基类指针里，再通过强制转换才能真正访问到子类对象，然后访问其成员。无法直接反序列化为子类指针，因为这种方式下不能进行指针的隐式转换。而下面所述的register_type方式可以直接反序列化到子类指针里。</p>
<p>还有一点需要注意的是，这毕竟是通过基类指针来序列化子类对象（多态），那么基类就必须要有虚函数，否则宏定义<code>BOOST_CLASS_EXPORT(CDerived)</code>是过不了的啊！</p>
<p><font size="5" color="orange">使用虚基类指针来序列化子类对象（通过register_type模板的方式)</font></p>
<hr>
<p>除了使用宏定义显式声明子类的方式以外，我们还可以通过register_type的方式，来实现用虚基类指针序列化子类对象：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//用虚基类指针序列化子类对象（使用register_type模板方式）</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CBase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CBase</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_BaseData</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> m_BaseData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> m_BaseData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_BaseData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CDerived</span> <span class="token operator">:</span><span class="token keyword">public</span> CBase
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token keyword">int</span> vBaseData<span class="token punctuation">,</span> <span class="token keyword">int</span> vDerivedData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">CBase</span><span class="token punctuation">(</span>vBaseData<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">m_DerivedData</span><span class="token punctuation">(</span>vDerivedData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span> <span class="token keyword">return</span> m_DerivedData<span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span>base_object<span class="token operator">&lt;</span>CBase<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Ar <span class="token operator">&amp;</span> m_DerivedData<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_DerivedData <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA<span class="token punctuation">.</span>register_type<span class="token operator">&lt;</span>CDerived<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//没有这行将无法用虚基类指针去序列化子类对象</span>
    CBase <span class="token operator">*</span>pBaseObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CDerived</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> pBaseObj<span class="token punctuation">;</span>
    <span class="token keyword">delete</span> pBaseObj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    IA<span class="token punctuation">.</span>register_type<span class="token operator">&lt;</span>CDerived<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CDerived <span class="token operator">*</span>pDerivedObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> pDerivedObj<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//基类必须有虚函数才可以进行转换</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span><span class="token string">"DerivedData: "</span> <span class="token operator">&lt;&lt;</span> pDerivedObj<span class="token operator">-</span><span class="token operator">></span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>值得注意的是，save和load函数里必须都调用register_type模板函数才能正确序列化和反序列化。</p>
<p>register_type的优点是只有需要序列化的类才注册。比如在开发一个库时，我们并不知道开发人员将来要序列化哪些类。BOOST_CLASS_EXPORT宏用起来更简单，但是它却可能注册那些不需要的类型。</p>
<p><font size="5" color="orange">使用make_array函数来优化类似数组的类型的归档字符串长度</font></p>
<hr>
<p>我们可以在序列化和反序列化之前，为vector这种类似数组的类型，加上boost::serialization::make_array函数，来缩短它们被序列化到归档文件中的字符串长度。该函数的第一个参数是指向容器内容的指针，第二个参数是需要序列化的容器元素的个数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//对标准容器的优化函数(make_array)，缩短归档字符串长度</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/text_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/serialization/vector.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> IntVec<span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span><span class="token function">make_array</span><span class="token punctuation">(</span>IntVec<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntVec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//用make_array函数来优化归档字符串长度</span>
    Fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>text_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> IntVec<span class="token punctuation">;</span>
    IntVec<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//需要事先初始化好足够的元素数量</span>
    IA <span class="token operator">>></span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span><span class="token function">make_array</span><span class="token punctuation">(</span>IntVec<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IntVec<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//必须用make_array来反序列化，且保证有足够的元素数量，否则无法正确反序列化出所有数据</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> e <span class="token operator">:</span> IntVec<span class="token punctuation">)</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> e <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
    Fin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>序列化后本地文件Serialization.txt中的内容如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token number">22</span> serialization<span class="token operator">::</span>archive <span class="token number">13</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如果不使用make_array函数，序列化后文件中的内容如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token number">22</span> serialization<span class="token operator">::</span>archive <span class="token number">13</span> <span class="token number">4</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>至于另一个优化函数<code>boost::serialization::make_binary_object ()</code>，哎，没试验成功。。。没找到这个函数在哪里。。。</p>
<p><font size="5" color="orange">序列化到xml文件</font></p>
<hr>
<p>如果想要序列化到xml文件，我们需要使用<code>boost::archive::xml_iarchive</code>和<code>boost::archive::xml_oarchive</code>来分别代替<code>boost::archive::text_iarchive</code>和<code>boost::archive::text_oarchive</code>，它们分别定义在boost/archive/xml_iarchive.hpp文件和boost/archive/xml_oarchive.hpp文件中。同时在所有的序列化操作之前，都必须先加上BOOST_SERIALIZATION_NVP宏定义或者boost::serialization::make_nvp：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//序列化成XML文档(BOOST_SERIALIZATION_NVP或boost::serialization::make_nvp)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/xml_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/xml_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> <span class="token function">BOOST_SERIALIZATION_NVP</span><span class="token punctuation">(</span>m_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>xml_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> boost<span class="token operator">::</span>serialization<span class="token operator">::</span><span class="token function">make_nvp</span><span class="token punctuation">(</span><span class="token string">"CustomDataObj"</span><span class="token punctuation">,</span> DataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//在定义该数据在xml中的标签名</span>
    Fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">Fin</span><span class="token punctuation">(</span><span class="token string">"Serialization.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>xml_iarchive <span class="token function">IA</span><span class="token punctuation">(</span>Fin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData DataObj<span class="token punctuation">;</span>
    IA <span class="token operator">>></span> <span class="token function">BOOST_SERIALIZATION_NVP</span><span class="token punctuation">(</span>DataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Fin<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">先序列化实际对象，再序列化指向对象的指针</font></p>
<hr>
<p>如果定义了一个对象，又定义了一个指向该对象的指针，并且要同时序列化这个对象和这个指针，那么必须先序列化这个对象，再序列化指向这个对象的指针，否则会运行出错：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//需要先序列化实际对象，再序列化指向对象的指针（反过来的话会出错，两者都需要序列化的情况下）</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/xml_iarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;boost/archive/xml_oarchive.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream></span></span>

<span class="token keyword">class</span> <span class="token class-name">CData</span>
<span class="token punctuation">{</span>
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">boost</span><span class="token operator">::</span>serialization<span class="token operator">::</span>access<span class="token punctuation">;</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token function">CData</span><span class="token punctuation">(</span><span class="token keyword">int</span> vData<span class="token punctuation">)</span> <span class="token operator">:</span><span class="token function">m_Data</span><span class="token punctuation">(</span>vData<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> Archive<span class="token operator">></span>
    <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span>Archive<span class="token operator">&amp;</span> Ar<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> vVersion<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Ar <span class="token operator">&amp;</span> <span class="token function">BOOST_SERIALIZATION_NVP</span><span class="token punctuation">(</span>m_Data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> m_Data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>ofstream <span class="token function">Fout</span><span class="token punctuation">(</span><span class="token string">"Serialization.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    boost<span class="token operator">::</span>archive<span class="token operator">::</span>xml_oarchive <span class="token function">OA</span><span class="token punctuation">(</span>Fout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token function">DataObj</span><span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CData <span class="token operator">*</span>pDataObj <span class="token operator">=</span> <span class="token operator">&amp;</span>DataObj<span class="token punctuation">;</span>
    OA <span class="token operator">&lt;&lt;</span> <span class="token function">BOOST_SERIALIZATION_NVP</span><span class="token punctuation">(</span>DataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//如果要同时序列化DataObj和pDataObj，需要先序列化前者，再序列化后者，反过来的话会出错</span>
    OA <span class="token operator">&lt;&lt;</span> <span class="token function">BOOST_SERIALIZATION_NVP</span><span class="token punctuation">(</span>pDataObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Fout<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的程序如果我们在save函数中先序列化pDataObj，再序列化DataObj就会运行报错。我们可以先看一下正常情况下，Serialization.xml中的内容：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> standalone<span class="token operator">=</span><span class="token string">"yes"</span> <span class="token operator">?</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE boost_serialization<span class="token operator">></span>
<span class="token operator">&lt;</span>boost_serialization signature<span class="token operator">=</span><span class="token string">"serialization::archive"</span> version<span class="token operator">=</span><span class="token string">"13"</span><span class="token operator">></span>
<span class="token operator">&lt;</span>DataObj class_id<span class="token operator">=</span><span class="token string">"0"</span> tracking_level<span class="token operator">=</span><span class="token string">"1"</span> version<span class="token operator">=</span><span class="token string">"0"</span> object_id<span class="token operator">=</span><span class="token string">"_0"</span><span class="token operator">></span>
    <span class="token operator">&lt;</span>m_Data<span class="token operator">></span><span class="token number">41</span><span class="token operator">&lt;</span><span class="token operator">/</span>m_Data<span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>DataObj<span class="token operator">></span>
<span class="token operator">&lt;</span>pDataObj class_id_reference<span class="token operator">=</span><span class="token string">"0"</span> object_id_reference<span class="token operator">=</span><span class="token string">"_0"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>pDataObj<span class="token operator">></span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到pDataObj是引用的DataObj的内容，因为它们两个代表的其实是同一个对象，所以(聪明的)boost序列化之后只存储了一个对象的内容，并没有存成两份相同的内容。所以当我们同时序列化源对象和指向该对象的指针时，必须先序列化源对象，指针才可以去引用嘛。当然，只序列化指向该对象的指针而不序列化源对象也是可以的，这里说的报错仅针对两者都要序列化的情况。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/03/30/Boost序列化/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2018/03/30/Boost序列化/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2018总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
