<!DOCTYPE HTML>
<html>

<head><meta name="generator" content="Hexo 3.9.0">
	<link rel="bookmark" type="image/x-icon" href="/img/logo_miccall.png">
	 <link rel="shortcut icon" href="/img/logo_miccall.png">
	
			
    <title>
    Elays'Blog
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<script>
	(function(){
		if('{{ page.password }}'){
			if (prompt('请输入博客密码') !== "elayRender"){
				alert('密码错误！');
				window.location.href='http://www.google.com'
				window.open('','_top'); 
				window.top.close(); 
				window.opener=null; 
				window.close();
			}
		}
	})();
	</script>
    <link rel="stylesheet" href="/css/mic_main.css">
    <link rel="stylesheet" href="/css/dropdownMenu.css">
    
    	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	
    <noscript>
        <link rel="stylesheet" href="/css/noscript.css">
    </noscript>
			    <script src="/js/jquery.min.js"></script>
    <script src="/js/jquery.scrollex.min.js"></script>
    <script src="/js/jquery.scrolly.min.js"></script>
    <script src="/js/skel.min.js"></script>
    <script src="/js/util.js"></script>
    <script src="/js/main.js"></script>
	
<link rel="stylesheet" href="/css/prism-dark.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    
		
<!-- Layouts -->


<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<!--<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">-->
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML">
</script>

<!--  代码渲染  -->
<link rel="stylesheet" href="/css/prism_undefined.css">
<link rel="stylesheet" href="/css/typo.css">
<!-- 文章页 -->
<body class="is-loading">
    <!-- Wrapper 外包 s-->
    <div id="wrapper" class="fade-in">
        <!-- Intro 头部显示 s -->
        <!-- Intro 头部显示 e -->
        <!-- Header 头部logo start -->
        <header id="header">
    <a href="/" class="logo">Elay</a>
</header>
        <!-- Nav 导航条 start -->
        <nav id="nav" class="special">
            <ul class="menu links">
			<!-- Homepage  主页  --> 
			<li>
	            <a href="/" rel="nofollow">主页</a>
	        </li>
			<!-- categories_name  分类   --> 
	        
	        <li class="active">
	            <a href="#s1">分类</a>
	                    <ul class="submenu">
	                        <li>
	                        <a class="category-link" href="/categories/C/">C#</a></li><li><a class="category-link" href="/categories/C-语法/">C#语法</a></li><li><a class="category-link" href="/categories/C/">C++</a></li><li><a class="category-link" href="/categories/C语言/">C语言</a></li><li><a class="category-link" href="/categories/Graphics/">Graphics</a></li><li><a class="category-link" href="/categories/Math/">Math</a></li><li><a class="category-link" href="/categories/OpenGL/">OpenGL</a></li><li><a class="category-link" href="/categories/Unity/">Unity</a></li><li><a class="category-link" href="/categories/Vulkan/">Vulkan</a></li><li><a class="category-link" href="/categories/博客配置/">博客配置</a></li><li><a class="category-link" href="/categories/并行计算/">并行计算</a></li><li><a class="category-link" href="/categories/操作系统/">操作系统</a></li><li><a class="category-link" href="/categories/数据结构/">数据结构</a></li><li><a class="category-link" href="/categories/毕设/">毕设</a></li><li><a class="category-link" href="/categories/游戏开发/">游戏开发</a></li><li><a class="category-link" href="/categories/计算机系统/">计算机系统</a></li><li><a class="category-link" href="/categories/设计模式/">设计模式</a>
	                    </li></ul>
	        </li>
	        
	        <!-- archives  归档   --> 
	        
	        
		        <!-- Pages 自定义   -->
		        


            </ul>
            <!-- icons 图标   -->
			<ul class="icons">
		            
		                <li><a href="null" class="icon fa-github"><span class="label">GitHub</span></a></li>
		            
		            
		            
		            
			</ul>
</nav>

        <div id="main">
            <div class="post_page_title_img" style="height: 25rem;background-image: url(https://github.com/Popperelay/Photos/blob/master/Photos/MPI_BG.jpg?raw=true);background-position: center; background-repeat:no-repeat; background-size:cover;-moz-background-size:cover;overflow:hidden;">
                <a href="#" style="padding: 4rem 4rem 2rem 4rem ;"><h2>MPI</h2></a>
            </div>
            <!-- Post -->
            <div class="typo" style="padding: 3rem;">
				<!-- 目录 -->
				<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:none">
				<span class="btn-bg"></span>
				<span class="btn-text">文章导航</span>
				</p>
				<div id="toc-article" class="toc-article">
					<span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">×</span>
					<strong class="toc-title">文章目录</strong>
					
			   </div>
			   <script type="text/javascript">
				function showToc(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:block");
					show_toc_btn.setAttribute("style","display:none");
					};
				function showBtn(){
					var toc_article = document.getElementById("toc-article");
					var show_toc_btn = document.getElementById("show-toc-btn");
					toc_article.setAttribute("style","display:none");
					show_toc_btn.setAttribute("style","display:block");
					};
			   </script>
				
                <p><font size="5" color="orange">概述</font></p>
<hr>
<p>MPI（Message Passing Interface，消息传递接口）实现的是进程级别的并行，通过通信在进程之间进行消息传递。它并不是一种新的程序语言，而是一个可以被C、C++、Fortran调用的函数库。</p>
<p><font size="5" color="orange">环境配置</font></p>
<hr>
<p>可以在<a href="https://msdn.microsoft.com/en-us/library/bb524831%28v=vs.85%29.aspx" target="_blank" rel="noopener">这里</a>下载最新的微软MPI，然后直接运行安装下载的两个文件：msmpisdk.msi和msmpisetup.exe。这两个文件运行安装之后，会在安装目录下出现Include和Lib文件夹，把它们分别添加到VS项目属性里就可以了（不太懂的话可以参考<a href="http://popperelay.cn/2016/10/18/OpenGL1%E6%A6%82%E8%BF%B0%E5%8F%8A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" target="_blank" rel="noopener">这里</a>的配置方法，是一个套路~）。</p>
<p><font size="5" color="orange">使用MPI的第一个Hello World程序</font></p>
<hr>
<p>先了解一下MPI常用的六个函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Init</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>argc<span class="token punctuation">,</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于对MPI这个并行环境进行初始化。其中<br>参数argc、argv的实参通常都来自main函数的形参（main函数形参具体可参考<a href="http://popperelay.cn/2017/12/20/C++Primer%E7%AC%AC%E5%85%AD%E7%AB%A0%E5%87%BD%E6%95%B0/" target="_blank" rel="noopener">这里</a>）。当然，也可以直接给argc和argv这两个参数传递nullptr。从MPI_Init函数后面开始一直到MPI_Finalize()函数（包括该函数）为止的代码，在每个进程中都会被执行一次。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_size</span> <span class="token punctuation">(</span>MPI_Comm comm <span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span> size <span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于获取通信子comm中的进程数size。通信子是一组可以互相发送消息的进程集合。MPI_COMM_WORLD是包含程序中所有进程的一个通信子。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_rank</span> <span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>rank<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于获取MPI并行程序中 ，当前进程在通信子comm中的进程编号rank。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Send</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Datatype datatype<span class="token punctuation">,</span> <span class="token keyword">int</span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> tag<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于进程间发送消息。将当前进程里count个datatype类型的数据（保存在buff里），发送到comm通信子里编号为dest的进程里，消息标签是tag（这个消息标签有点像对暗号或者是邮戳，接收方必须要有可以兼容的标签才可以接收该消息）。前三个参数构成了消息数据，后三个参数构成了消息信封。datatype必须是MPI自己定义的数据类型，比如MPI_INT。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Recv</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token operator">*</span>buff<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Datatype datatype<span class="token punctuation">,</span> <span class="token keyword">int</span> source<span class="token punctuation">,</span> <span class="token keyword">int</span> tag<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于进程间接收消息。从comm通信子里编号为source的进程里接收<strong>最多</strong>count个datatype类型的数据，接收后存放到buff里。tag是消息标签，只有进程号和标签号都对的上的消息才会被接收。status是一个结构体，保存了实际接收消息的状态消息，比如源进程号、消息标签、包含的数据项个数等等。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于进程退出MPI系统，所有进程正常退出都必须调用它。它表明并行代码的结束，结束除主进程(rank=0)外的其他进程。串行代码仍可在主进程上继续执行，但不能再有MPI函数，包括MPI_Init()函数。</p>
<p>我们可以来看一下这个MPI并行的Hello World程序了：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//MPI实例中最简单的HelloWorld</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> MyId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> NumProcs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> NameLen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> ProcessorName<span class="token punctuation">[</span>MPI_MAX_PROCESSOR_NAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>argc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">//环境初始化，后面直到MPI_Finalize（包括它）的代码段，在每个进程中都会被执行一次</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>MyId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//获取本进程在通信空间中的rank值（类似进程ID号）</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NumProcs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//获得进程个数</span>
    <span class="token function">MPI_Get_processor_name</span><span class="token punctuation">(</span>ProcessorName<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NameLen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Hello World form process "</span> <span class="token operator">&lt;&lt;</span> MyId <span class="token operator">&lt;&lt;</span> <span class="token string">"th of "</span> <span class="token operator">&lt;&lt;</span> NumProcs <span class="token operator">&lt;&lt;</span> <span class="token string">" processes, named "</span> <span class="token operator">&lt;&lt;</span> ProcessorName <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">//退出MPI系统，所有进程正常退出都必须调用它。表明并行代码的结束，结束除主进程外的其他进程，串行代码仍可在主进程(rank=0)上运行</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>想要使用mpi当然需要包含头文件mpi.h了。编译程序后会生成exe文件，通过cmd进入exe所在的文件目录下，输入：mpiexec -n 4 MPI(HelloWorld).exe，开始并行执行上面的代码。其中4表示使用4个进程进行并行计算。运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">4</span> <span class="token function">MPI</span><span class="token punctuation">(</span>HelloWorld<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Hello World form process 2th of <span class="token number">4</span> processes<span class="token punctuation">,</span> named elay
Hello World form process 1th of <span class="token number">4</span> processes<span class="token punctuation">,</span> named elay
Hello World form process 3th of <span class="token number">4</span> processes<span class="token punctuation">,</span> named elay
Hello World form process 0th of <span class="token number">4</span> processes<span class="token punctuation">,</span> named elay
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果觉得从cmd输入文件目录比较麻烦，可以将下面的内容保存为.reg注册表文件，双击运行以后就会在鼠标右键里看到“Open cmd here as Admin”。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Windows Registry Editor Version <span class="token number">5.00</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Directory\shell\runas<span class="token punctuation">]</span>
@<span class="token operator">=</span><span class="token string">"Open cmd here as Admin"</span>
<span class="token string">"HasLUAShield"</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Directory\shell\runas\command<span class="token punctuation">]</span>
@<span class="token operator">=</span><span class="token string">"cmd.exe /s /k pushd \"%V\""</span>
<span class="token punctuation">[</span><span class="token operator">-</span>HKEY_CLASSES_ROOT\Directory\Background\shell\runas<span class="token punctuation">]</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Directory\Background\shell\runas<span class="token punctuation">]</span>
@<span class="token operator">=</span><span class="token string">"Open cmd here as Admin"</span>
<span class="token string">"HasLUAShield"</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Directory\Background\shell\runas\command<span class="token punctuation">]</span>
@<span class="token operator">=</span><span class="token string">"cmd.exe /s /k pushd \"%V\""</span>
<span class="token punctuation">[</span><span class="token operator">-</span>HKEY_CLASSES_ROOT\Drive\shell\runas<span class="token punctuation">]</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Drive\shell\runas<span class="token punctuation">]</span>
@<span class="token operator">=</span><span class="token string">"Open cmd here as Admin"</span>
<span class="token string">"HasLUAShield"</span><span class="token operator">=</span><span class="token string">""</span>
<span class="token punctuation">[</span>HKEY_CLASSES_ROOT\Drive\shell\runas\command<span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MPI还提供一个同时发送和接收的函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Sendrecv</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcount<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">int</span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> sendtag<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> recvcount<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span> <span class="token keyword">int</span> source<span class="token punctuation">,</span> <span class="token keyword">int</span> recvtag<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>它可以在一条语句中同时实现向其他进程发送数据和从其他进程接收数据的操作。可以有效地避免不合理的通信次序，最大限度避免死锁的产生。其参数和发送、接收函数的参数含义相同，就不再赘述了。</p>
<p><font size="5" color="orange">并行计算复化梯形积分</font></p>
<hr>
<p>复化梯形积分法的基本思想是：将x轴上的区间划分为n个等长的子区间，然后计算子区间的和。具体可参考<a href="https://baike.baidu.com/item/%E5%A4%8D%E5%8C%96%E6%B1%82%E7%A7%AF%E5%85%AC%E5%BC%8F/19131010?fr=aladdin" target="_blank" rel="noopener">这里</a>。<br>其串行版本如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">102400000</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> a <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">4.0</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> h <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">/</span> n<span class="token punctuation">;</span>
<span class="token keyword">double</span> ApproximateArea <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> x_i <span class="token operator">=</span> a <span class="token operator">+</span> i <span class="token operator">*</span> h<span class="token punctuation">;</span>
    ApproximateArea <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x_i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ApproximateArea <span class="token operator">*</span><span class="token operator">=</span> h<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>比如我们现在要求f(x)=x^2，在区间0到4上的积分。我们可以把0到4这个区间分成n=1024个等长的子区间。如果采用串行版本，就需要依次计算1024个子区间的面积。很容易看到每个子区间面积的计算都是相互独立的，所以我们是可以用并行的方式来计算这些子区间面积的。当然，我们可能并没有1024个进程来分别计算每一个子区间的面积，可能只有8个或16个进程。我们可以让每个进程都执行上面的串行代码，来同时负责计算不同的多个子区间的面积和（8个进程的话就是每个进程负责计算128个子区间的面积和），然后再把它们加起来得到最终的积分面积。所以并行代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//点对点通信，计算复化梯形积分</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">double</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">trapArea</span><span class="token punctuation">(</span><span class="token keyword">double</span> vTrapsL<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapsR<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapCount<span class="token punctuation">,</span> <span class="token keyword">double</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span>  ProcessNum<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">102400000</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> a <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">4.0</span><span class="token punctuation">,</span> TotalArea <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> h <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">/</span> n<span class="token punctuation">;</span>

    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span>       Local_n <span class="token operator">=</span> n <span class="token operator">/</span> ProcessNum<span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">//每个进程要处理的梯形数目</span>
    <span class="token keyword">double</span> Local_a <span class="token operator">=</span> a <span class="token operator">+</span> CurrentRank <span class="token operator">*</span> Local_n <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">double</span> Local_b <span class="token operator">=</span> Local_a <span class="token operator">+</span> Local_n <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">double</span> LocalArea <span class="token operator">=</span> <span class="token function">trapArea</span><span class="token punctuation">(</span>Local_a<span class="token punctuation">,</span> Local_b<span class="token punctuation">,</span> Local_n<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//每个进程调用trapArea这个串行代码来计算自己负责的多个子区间的面积和</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>LocalArea<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//其他进程把自己计算的面积和发送给0号进程</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        TotalArea <span class="token operator">=</span> LocalArea<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ProcessNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">MPI_Recv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>LocalArea<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> MPI_STATUS_IGNORE<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//0号进程接收其他进程计算的面积和</span>
            TotalArea <span class="token operator">+</span><span class="token operator">=</span> LocalArea<span class="token punctuation">;</span>                                                            <span class="token comment" spellcheck="true">//把这些面积和加起来，得到最终的积分面积</span>
        <span class="token punctuation">}</span>
        ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ElapsedTime<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"With "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" trapezoids, our estimate:"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The integral from "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" is: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>TotalArea<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The elapsed time is: "</span> <span class="token operator">&lt;&lt;</span> ElapsedTime <span class="token operator">&lt;&lt;</span> <span class="token string">" seconds"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token operator">*</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">trapArea</span><span class="token punctuation">(</span><span class="token keyword">double</span> vTrapsL<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapsR<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapCount<span class="token punctuation">,</span> <span class="token keyword">double</span> h<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> ApproximateArea <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>vTrapsL<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>vTrapsR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vTrapCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        x <span class="token operator">=</span> vTrapsL <span class="token operator">+</span> i <span class="token operator">*</span> h<span class="token punctuation">;</span>
        ApproximateArea <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ApproximateArea <span class="token operator">*</span><span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ApproximateArea<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">64</span> <span class="token function">MPI2</span><span class="token punctuation">(</span>TrapezoidalIntegration<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
With <span class="token number">102400000</span> trapezoids<span class="token punctuation">,</span> our estimate<span class="token operator">:</span>
The integral from <span class="token number">0.000000</span> to <span class="token number">4.000000</span> is<span class="token operator">:</span> <span class="token number">21.333333</span>
The elapsed time is<span class="token operator">:</span> <span class="token number">0.0084099</span> seconds
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们将102400000个子区间平均分配到64个进程中进程子任务求解，求解完成后，1-99号进程计算的结果将通过MPI_Send函数发送出去，而0号进程使用MPI_Recv函数接收汇总，将每个进程的结果求和，得到总区间[a, b]上的积分值。而同样地用串行程序计算积分的结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Integration result is<span class="token operator">:</span> <span class="token number">21.3333</span>
The elapsed time is<span class="token operator">:</span> <span class="token number">0.092</span> seconds
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>可以看到并行程序的时间开销确实少了很多（在子区间个数n比较大的时候差距才比较明显）。</p>
<p>我们把梯形面积计算均摊到100个进程里了，但最后的面积求和操作都是0号进程在做，0号进程在求和时，其他进程几乎都处于空闲，这无疑会浪费资源？有没有什么办法可以让其他进程也一起加入求和过程呢？这就需要使用集合通信了。</p>
<p><font size="5" color="orange">使用集合通信来并行计算复化梯形积分</font></p>
<hr>
<p>上一节并行计算复化梯形积分的方法，其实是点对点通信，即单个进程对单个进程的通信。所有的求和过程都让进程0来做了。求和过程图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_1.png?raw=true" alt><br>1到7号进程将自己计算的结果（5,2,6,2,1,9,10,4）发送给0号进程，0号进程收到后把它们加起来。可以看到0号进程做了7次接收和7次加法操作。如果进程之间可以按照下图这样两两归并相加呢？<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_2.png?raw=true" alt><br>那么0号进程只做了3次接收和3次加法操作。而整个并行系统中必然是0号进程花费的时间最多（因为它既要计算面积，又要进行面积加和操作），所以0号进程所花费的时间就是整个并行系统计算的时间。如果是1024个进程，按照原来的做法0号进程需要1023次接收和加法操作；但是如果按照这种归并方式，0号进程只需要做10次接收和加法操作(上面那幅图很像二叉树嘛，所以是log2(n）)，这样一来并行计算的效率就提高了100倍！</p>
<p>这涉及到了进程集合之间的通信，即集合通信。幸运的是，MPI已经给我们封装好了这种类似的归约操作，使用MPI_Reduce函数就可以实现：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//集合通信，计算梯形积分，使用归约的方式（Reduce，多到一）</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">double</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">double</span> <span class="token function">trapArea</span><span class="token punctuation">(</span><span class="token keyword">double</span> vTrapsL<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapsR<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapCount<span class="token punctuation">,</span> <span class="token keyword">double</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span>  ProcessNum<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> n <span class="token operator">=</span> <span class="token number">102400000</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> a <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">4.0</span><span class="token punctuation">,</span> TotalArea <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> h <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">/</span> n<span class="token punctuation">;</span>

    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span>       Local_n <span class="token operator">=</span> n <span class="token operator">/</span> ProcessNum<span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">//每个进程要处理的梯形数目</span>
    <span class="token keyword">double</span> Local_a <span class="token operator">=</span> a <span class="token operator">+</span> CurrentRank <span class="token operator">*</span> Local_n <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">double</span> Local_b <span class="token operator">=</span> Local_a <span class="token operator">+</span> Local_n <span class="token operator">*</span> h<span class="token punctuation">;</span>
    <span class="token keyword">double</span> LocalArea <span class="token operator">=</span> <span class="token function">trapArea</span><span class="token punctuation">(</span>Local_a<span class="token punctuation">,</span> Local_b<span class="token punctuation">,</span> Local_n<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//每个进程调用trapArea这个串行代码来计算自己负责的多个子区间的面积和</span>

    <span class="token function">MPI_Reduce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>LocalArea<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TotalArea<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> MPI_SUM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//MPI_SUM是归约操作符</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ElapsedTime<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"With "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" trapezoids, our estimate:"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The integral from "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" to "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" is: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>TotalArea<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"The elapsed time is: "</span> <span class="token operator">&lt;&lt;</span> ElapsedTime <span class="token operator">&lt;&lt;</span> <span class="token string">" seconds"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> x<span class="token operator">*</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">double</span> <span class="token function">trapArea</span><span class="token punctuation">(</span><span class="token keyword">double</span> vTrapsL<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapsR<span class="token punctuation">,</span> <span class="token keyword">double</span> vTrapCount<span class="token punctuation">,</span> <span class="token keyword">double</span> h<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> ApproximateArea <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span>vTrapsL<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">f</span><span class="token punctuation">(</span>vTrapsR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> x <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> vTrapCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        x <span class="token operator">=</span> vTrapsL <span class="token operator">+</span> i <span class="token operator">*</span> h<span class="token punctuation">;</span>
        ApproximateArea <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ApproximateArea <span class="token operator">*</span><span class="token operator">=</span> h<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ApproximateArea<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>唯一不同的是，这段代码中，我们不再使用MPI_Send和MPI_Recv这样点对点的通信函数，而是使用了一个MPI_Reduce函数（函数什么意思后续再讲）。程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mpiexec <span class="token operator">-</span>n <span class="token number">1024</span> <span class="token function">MPI3</span><span class="token punctuation">(</span>Reduce<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
With <span class="token number">102400000</span> trapezoids<span class="token punctuation">,</span> our estimate<span class="token operator">:</span>
The integral from <span class="token number">0.000000</span> to <span class="token number">4.000000</span> is<span class="token operator">:</span> <span class="token number">21.333333</span>
The elapsed time is<span class="token operator">:</span> <span class="token number">0.105715</span> seconds
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>而同样在1024个进程下，之前点对点版本的程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mpiexec <span class="token operator">-</span>n <span class="token number">1024</span> <span class="token function">MPI2</span><span class="token punctuation">(</span>TrapezoidalIntegration<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
With <span class="token number">102400000</span> trapezoids<span class="token punctuation">,</span> our estimate<span class="token operator">:</span>
The integral from <span class="token number">0.000000</span> to <span class="token number">4.000000</span> is<span class="token operator">:</span> <span class="token number">21.333333</span>
The elapsed time is<span class="token operator">:</span> <span class="token number">0.509458</span> seconds
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到使用MPI_Reduce的集合通信的计算速度确实是点对点通信的5倍左右（并没有理论上的10倍那么高~），而且进程数增加时似乎并行计算的时间也增多了（比之前64个进程点对点通信的时间长），个人猜想可能是系统自身分不出这么多进程造成的原因~。</p>
<p>下面我们先来详细看一下集合通信。</p>
<p><font size="5" color="orange">集合通信</font></p>
<hr>
<p>在MPI中，涉及所有的进程的通信函数我们称之为集合通信。而单个进程对单个进程的通信，类似于MPI_Send和MPI_Recv这样的通信函数，我们称之为点对点通信。集合通信具有一下特点：</p>
<ul>
<li>在通信子中的所有进程都必须调用相同的集合通信函数</li>
<li>每个进程传递给MPI集合通信函数的参数必须是“相容的”</li>
<li>点对点通信函数是通过标签和通信子来匹配的，而集合通信函数不使用标签，只是通过通信子和调用的顺序来进行匹配。</li>
</ul>
<p>下表汇总了MPI中的集合通信函数：</p>
<table>
<thead>
<tr>
<th style="text-align:center">类型</th>
<th style="text-align:center">函数</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">数据移动</td>
<td style="text-align:center">MPI_Bcast</td>
<td style="text-align:center">一到多，数据广播</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Gather</td>
<td style="text-align:center">到一，数据汇合</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Gatherv</td>
<td style="text-align:center">MPI_Gather的变种，数据块长度可以不同</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Allgather</td>
<td style="text-align:center">MPI_Gather的变种，把结果值分发给每一个进程</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Allgatherv</td>
<td style="text-align:center">MPI_Allgather的变种，数据块长度可以不同</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Scatter</td>
<td style="text-align:center">一到多，数据分散</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Scatterv</td>
<td style="text-align:center">MPI_Scatter的变种，数据块长度可以不同</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Alltoall</td>
<td style="text-align:center">多到多，数据置换（全交换）</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Alltoallv</td>
<td style="text-align:center">MPI_Alltoall的变种，数据块长度可以不同</td>
</tr>
<tr>
<td style="text-align:center">数据聚集</td>
<td style="text-align:center">MPI_Reduce</td>
<td style="text-align:center">多到一，数据归约</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Allreduce</td>
<td style="text-align:center">MPI_Reduce的变种，把结果值分发给每一个进程</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Reduce_Scatter</td>
<td style="text-align:center">MPI_Reduce的变种，把结果值散射到每一个进程</td>
</tr>
<tr>
<td style="text-align:center"></td>
<td style="text-align:center">MPI_Scan</td>
<td style="text-align:center">扫描归约，各进程以此得到部分归约的结果</td>
</tr>
<tr>
<td style="text-align:center">同步</td>
<td style="text-align:center">MPI_Barrier</td>
<td style="text-align:center">同步操作</td>
</tr>
</tbody>
</table>
<p>下面分别来具体看一下这些函数。</p>
<p><font size="5" color="orange">归约</font></p>
<hr>
<p>数据归约的基本功能是从每个进程收集数据，把这些数据归约成单个值，把归约的值存储到根进程中。MPI_Reduce函数就是用来完成归约过程的，函数原型如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Reduce</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>MPI_Datatype datatype<span class="token punctuation">,</span> MPI_Op op<span class="token punctuation">,</span> <span class="token keyword">int</span> root<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>除了op以外，其他参数的含义都与MPI_Send和MPI_Recv函数相同。MPI_Op表示MPI归约中得操作符，我们上面的程序中所用的就是求累加和的归约操作符。MPI提供的所有归约操作符如下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">归约操作符</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MPI_MAX</td>
<td>最大值</td>
</tr>
<tr>
<td style="text-align:center">MPI_MIN</td>
<td>最小值</td>
</tr>
<tr>
<td style="text-align:center">MPI_SUM</td>
<td>求和</td>
</tr>
<tr>
<td style="text-align:center">MPI_PROD</td>
<td>求积</td>
</tr>
<tr>
<td style="text-align:center">MPI_LAND</td>
<td>逻辑与</td>
</tr>
<tr>
<td style="text-align:center">MPI_LOR</td>
<td>逻辑或</td>
</tr>
<tr>
<td style="text-align:center">MPI_LXOR</td>
<td>逻辑异或</td>
</tr>
<tr>
<td style="text-align:center">MPI_BAND</td>
<td>位与</td>
</tr>
<tr>
<td style="text-align:center">MPI_BOR</td>
<td>位或</td>
</tr>
<tr>
<td style="text-align:center">MPI_BXOR</td>
<td>位异或</td>
</tr>
<tr>
<td style="text-align:center">MPI_MINLOC</td>
<td>计算一个全局最小值和附加到这个最小值上的进程索引</td>
</tr>
<tr>
<td style="text-align:center">MPI_MAXLOC</td>
<td>计算一个全局最大值和附加到这个最大值上的进程索引</td>
</tr>
</tbody>
</table>
<p>数据归约还有以下一些变种函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Allreduce</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>MPI_Datatype datatype<span class="token punctuation">,</span> MPI_Op op<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>此函数在得到归约值以后，将结果值分发给每一个进程，这样的话，并行中的所有进程都能知道结果值了。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_3.jpg?raw=true" alt></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Reduce_scatter</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>recvcnts<span class="token punctuation">,</span>MPI_Datatype datatype<span class="token punctuation">,</span> MPI_Op op<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数在得到归约值以后，再将结果进行一次散发操作（散发后续详述）。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Scan</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>MPI_Datatype datatype<span class="token punctuation">,</span> MPI_Op op<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数完成扫描归约（又叫前缀归约），它会将<strong>部分</strong>归约结果依次发送给每个进程。</p>
<p><font size="5" color="orange">广播</font></p>
<hr>
<p>在一个集合通信中，如果属于一个进程的数据被发送到通信子中的所有进程，这样的集合通信就叫做广播。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_4.png?raw=true" alt></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Bcast</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span>MPI_Datatype datatype<span class="token punctuation">,</span> <span class="token keyword">int</span> root<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>通信子comm中进程号为root的根进程把自己buffer中的count个datatype类型的数据，发送给通信子中所有其他进程。实例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//集合通信，广播：将一个进程中的数据发送到通信子中的所有进程</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">CBroadcast</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">CBroadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">broadcastData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> CBroadcast<span class="token operator">::</span><span class="token function">broadcastData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Barrier</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//阻塞，等所有进程都运行到这里之后再继续执行</span>
    <span class="token keyword">double</span> ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> DataBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//将root进程（这里是0）的DataBuf中的内容发送给通信子中的所有进程</span>

    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Current rankID = "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>CurrentRank<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", Received Data are: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

    ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ElapsedTime<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Elapsed time is: "</span> <span class="token operator">&lt;&lt;</span> ElapsedTime <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CBroadcast Broadcast<span class="token punctuation">;</span>
    Broadcast<span class="token punctuation">.</span><span class="token function">broadcastData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">8</span> <span class="token function">MPI4</span><span class="token punctuation">(</span>Broadcast<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Current rankID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Current rankID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">9</span>
Elapsed time is<span class="token operator">:</span> <span class="token number">3.58895e-05</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">散射</font></p>
<hr>
<p>根进程将数据<strong>分块</strong>发送给各个进程的集合通信就叫散射。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_5.png?raw=true" alt></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Scatter</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> recvcnt<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span><span class="token keyword">int</span> root<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>根进程将自己sendbuf中的np（np是通信子comm中的进程总数）个连续存放的数据块按进程号的顺序依次发送给comm中的所有进程（包括根进程自己）的recvbuf中。值得注意的是，sendcnt和recvcnt是每个进程发送或接收的一个数据块的长度，而不是发送给所有进程得数据长度之和。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Scatterv</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>sendcnts<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>displs<span class="token punctuation">,</span> MPI_Datatype sendtype<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> recvcnt<span class="token punctuation">,</span>MPI_Datatype recvtype<span class="token punctuation">,</span> <span class="token keyword">int</span> root<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>散发不同长度的数据块。与MPI_Scatter类似，但允许sendbuf中每个数据块的长度不同并且可以按任意的顺序排放。数组sendcnts和displs的元素个数等于comm中的进程数，它们分别给出发送给每个进程的数据长度和位移，均以sendtype为单位。</p>
<p>示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//集合通信，散射scatter：根进程将数据分块发送给所有进程进行并行计算</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">CScatter</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CScatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">CScatter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">scatterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> CScatter<span class="token operator">::</span><span class="token function">scatterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">float</span> DataBuf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token number">1.0</span><span class="token punctuation">,</span><span class="token number">2.0</span><span class="token punctuation">,</span><span class="token number">3.0</span><span class="token punctuation">,</span><span class="token number">4.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">5.0</span><span class="token punctuation">,</span><span class="token number">6.0</span><span class="token punctuation">,</span><span class="token number">7.0</span><span class="token punctuation">,</span><span class="token number">8.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">9.0</span><span class="token punctuation">,</span><span class="token number">10.0</span><span class="token punctuation">,</span><span class="token number">11.0</span><span class="token punctuation">,</span><span class="token number">12.0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token number">13.0</span><span class="token punctuation">,</span><span class="token number">14.0</span><span class="token punctuation">,</span><span class="token number">15.0</span><span class="token punctuation">,</span><span class="token number">16.0</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">float</span> ReceiveBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Scatter</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> MPI_FLOAT<span class="token punctuation">,</span> ReceiveBuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> MPI_FLOAT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//将0号进程DataBuf里的数据分块散射到通信子的所有进程里</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Current rankID = "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>CurrentRank<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", Received Data are: "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>ReceiveBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>ReceiveBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>ReceiveBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>ReceiveBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please specify -n 4"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CScatter Scatter<span class="token punctuation">;</span>
    Scatter<span class="token punctuation">.</span><span class="token function">scatterData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">4</span> <span class="token function">MPI5</span><span class="token punctuation">(</span>Scatter<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Current rankID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">1.000000</span><span class="token punctuation">,</span><span class="token number">2.000000</span><span class="token punctuation">,</span><span class="token number">3.000000</span><span class="token punctuation">,</span><span class="token number">4.000000</span>
Current rankID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">5.000000</span><span class="token punctuation">,</span><span class="token number">6.000000</span><span class="token punctuation">,</span><span class="token number">7.000000</span><span class="token punctuation">,</span><span class="token number">8.000000</span>
Current rankID <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">9.000000</span><span class="token punctuation">,</span><span class="token number">10.000000</span><span class="token punctuation">,</span><span class="token number">11.000000</span><span class="token punctuation">,</span><span class="token number">12.000000</span>
Current rankID <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">13.000000</span><span class="token punctuation">,</span><span class="token number">14.000000</span><span class="token punctuation">,</span><span class="token number">15.000000</span><span class="token punctuation">,</span><span class="token number">16.000000</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">聚集</font></p>
<hr>
<p>每个进程都将自己的一块数据发送给根进程的集合通信就叫聚集。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_6.png?raw=true" alt></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Gather</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> recvcnt<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span><span class="token keyword">int</span> root<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>收集相同长度的数据块。所有进程（包括根进程自己）将sendbuf中的数据块发送给根进程root，根进程将这些数据块按进程号的顺序依次放到recvbuf中。和散射一样，sendcnt和recvcnt是每个进程发送或接收的一个数据块的长度。示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//集合通信，聚集gather：所有进程将数据块发送给根进程，根进程按进程号依次存储接收到的数据块</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">class</span> <span class="token class-name">CGather</span>
<span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">CGather</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">CGather</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">gatherData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> CGather<span class="token operator">::</span><span class="token function">gatherData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Barrier</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> <span class="token operator">*</span>pReceiveBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span>ProcessNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">_ASSERT</span><span class="token punctuation">(</span>pReceiveBuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> SendBuf <span class="token operator">=</span> CurrentRank<span class="token punctuation">;</span>

    <span class="token function">MPI_Gather</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SendBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> pReceiveBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ElapsedTime <span class="token operator">=</span> <span class="token function">MPI_Wtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> ElapsedTime<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ProcessNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"pReceiveBuf["</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">"] = "</span> <span class="token operator">&lt;&lt;</span> pReceiveBuf<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl <span class="token operator">&lt;&lt;</span> <span class="token string">"Elapsed time is: "</span> <span class="token operator">&lt;&lt;</span> ElapsedTime <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    CGather Gather<span class="token punctuation">;</span>
    Gather<span class="token punctuation">.</span><span class="token function">gatherData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该程序里，每个进程将自己的进程序号发送给根进程。程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">4</span> <span class="token function">MPI6</span><span class="token punctuation">(</span>Gather<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
pReceiveBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> pReceiveBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> pReceiveBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> pReceiveBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
Elapsed time is<span class="token operator">:</span> <span class="token number">0.000143558</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>该函数还有其他变种：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Allgather</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> recvcnt<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>MPI_Allgather与MPI_Gather类似，区别是所有进程同时将数据收集到recvbuf中，因此也称为数据全收集，它相当于以comm中的每个进程为根进程来调用一次MPI_Gather函数；也相当于任意一个进程调用MPI_Gather之后再把收集到的数据广播到所有进程里。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Gatherv</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>recvcnts<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>displs<span class="token punctuation">,</span>MPI_Datatype recvtype<span class="token punctuation">,</span> <span class="token keyword">int</span> root<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数允许每个进程发送得数据块长度不同。其参数和MPI_Scatterv的参数含义相同。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Allgatherv</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>recvcnts<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>displs<span class="token punctuation">,</span>MPI_Datatype recvtype<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不同长度数据块的全收集。</p>
<p><font size="5" color="orange">转置</font></p>
<hr>
<p>对通信子中的所有进程，将进程i的第j块数据发送到进程j的第i个位置的集合通信就叫转置。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_7.png?raw=true" alt></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Alltoall</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> sendcnt<span class="token punctuation">,</span>MPI_Datatype sendtype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span><span class="token keyword">int</span> recvcnt<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>相同长度数据块的全转置：将进程i将sendbuf中的第j块数据发送到进程j的recvbuf中的第i个位置。sendcnt和recvcnt都是指一个数据块的长度。如果对一个二维数组使用该函数，则接收到的结果就是该二维数组的转置。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Alltoallv</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>sendbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>sendcnts<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>sdispls<span class="token punctuation">,</span> MPI_Datatype sendtype<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>recvbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>recvcnts<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>rdispls<span class="token punctuation">,</span> MPI_Datatype recvtype<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>不同长度数据块的全转置。每个数据块的长度可以不等，并且不要求连续存放。</p>
<p><font size="5" color="orange">MPI并行程序的两种基本模式</font></p>
<hr>
<p>MPI两种最基本的并行程序设计模式是：对等模式和主从模式。<br>对等模式：各个部分地位相同，功能和代码基本一致，只不过是处理的数据或对象不同，也容易用相同的程序来实现。<br>主从模式：分为主进程和从进程，程序通信进程之间的一种主从或依赖关系，主程序运行一套代码，从进程运行另一套代码。</p>
<p>之前点对点通信并行计算复化梯形积分的程序，就是一种简单的主从模式，因为0号进程和其他进程执行的代码不一样：它还需要收集其他进程（从进程）计算的面积来进行求和，得到最终的积分面积。我们再看一个主从模式的实例代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MSG_TAG_EXIT 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MSG_TAG_PRINT 1</span>

<span class="token keyword">void</span> <span class="token function">slaver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">master</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">master</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">slaver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">slaver</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//从进程代码段</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> Message<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sprintf_s</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token string">"Hello World from process %d"</span><span class="token punctuation">,</span> CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Send</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">,</span> MPI_CHAR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_TAG_PRINT<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf_s</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token string">"Hello World from process %d again"</span><span class="token punctuation">,</span> CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Send</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">,</span> MPI_CHAR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_TAG_PRINT<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sprintf_s</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token string">"Bye from process %d"</span><span class="token punctuation">,</span> CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Send</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>Message<span class="token punctuation">)</span><span class="token punctuation">,</span> MPI_CHAR<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MSG_TAG_EXIT<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">master</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//主进程代码段</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ProcessSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> SlaverCount <span class="token operator">=</span> ProcessSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> Message<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>SlaverCount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//主要还有从进程，则执行接收和打印消息</span>
    <span class="token punctuation">{</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Recv</span><span class="token punctuation">(</span>Message<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> MPI_CHAR<span class="token punctuation">,</span> MPI_ANY_SOURCE<span class="token punctuation">,</span> MPI_ANY_TAG<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//接收任何进程发出的任何消息</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>Status<span class="token punctuation">.</span>MPI_TAG<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> MSG_TAG_PRINT<span class="token operator">:</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> Message <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//主进程收到从进程发来的消息标签如果是MSG_TAG_PRINT，就打印消息</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> MSG_TAG_EXIT<span class="token operator">:</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> Message <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//主进程收到从进程发来的消息标签如果是MSG_TAG_EXIT，就令从进程数减1</span>
            <span class="token operator">--</span>SlaverCount<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段代码的主从关系就更明显了，主进程（0号）和从进程（其他进程）执行的明显是两套代码。从进程负责发送多个消息，每个消息可能有不同的消息标签，而主进程负责接收所有消息然后打印消息内容，直到所有的从进程都退出并行系统为止。</p>
<p><font size="5" color="orange">MPI的4种通信模式</font></p>
<hr>
<p>这里所说的通信模式不是指点对点通信或集合通信，而是：</p>
<ul>
<li>标准通信模式：MPI_SEND</li>
<li>缓存通信模式：MPI_BSEND</li>
<li>同步通信模式：MPI_SSEND</li>
<li>就绪通信模式：MPI_RSEND</li>
</ul>
<p>这四种通信模式的区别都在消息发送端，消息接收端的操作都是MPI_RECV。</p>
<p><font size="5" color="orange">标准通信模式</font></p>
<hr>
<p>标准通信模式下，是否对发送的数据进行缓存是由MPI决定的，而不是由并行程序员来控制。</p>
<ul>
<li>如果MPI不缓存将要发送的数据：对于阻塞通信，只有当相应的接收调用被执行后，并且发送数据完全到达接收缓冲区后，发送操作才算完成；对于非阻塞通信，发送操作虽然没有完成，但是发送调用可以正确返回，程序可以接下来执行其他的操作。</li>
<li>如果MPI缓冲将要发送的数据：发送操作不管接收操作是否执行，都可以进行；而且缓冲结束后发送操作就可以完成并返回，不需要等待接收操作接收到数据。</li>
</ul>
<p>图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_8.png?raw=true" alt></p>
<p><font size="5" color="orange">缓存通信模式</font></p>
<hr>
<p>缓存通信模式下，由用户直接对通信缓冲区进行申请、使用和释放。缓存通信模式和上图由MPI决定的缓冲方式一样，消息发送能否进行以及能否正确返回都不依赖于接收进程，完全依赖于是否有足够的通信缓冲区可用。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Buffer_attach</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//用于申请缓存 </span>
<span class="token keyword">int</span> <span class="token function">MPI_Buffer_detach</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>size<span class="token punctuation">)</span> <span class="token comment" spellcheck="true">//用于释放缓存，这是一个阻塞调用，函数返回表示缓冲区已经被释放</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>释放缓冲是阻塞调用，它一直等到使用该缓存的消息发送完成后才返回，这一调用返回后用户可以重新使用该缓冲区。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_9.png?raw=true" alt><br>示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Src <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Dest <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> Buffer<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>pTempBuffer <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>pTempBuffer2 <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"This program uses exactly 2 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> Src<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//当前为发送进程</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ProcessNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            Buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> TempSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Pack_size</span><span class="token punctuation">(</span>ProcessNum<span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TempSize<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//计算发送ProcessNum个MPI_DOUBLE类型的数据需要多大空间</span>
        pTempBuffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span>TempSize <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> MPI_BSEND_OVERHEAD<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//申请缓存发送所需要的空间</span>
        <span class="token function">_ASSERT</span><span class="token punctuation">(</span>pTempBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Buffer_attach</span><span class="token punctuation">(</span>pTempBuffer<span class="token punctuation">,</span> TempSize <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> MPI_BSEND_OVERHEAD<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">//将申请的缓存空间递交给MPI，告诉MPI_Bsend需要发送数据时去该缓存里拿</span>
        <span class="token function">MPI_Bsend</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ProcessNum<span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> Dest<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//执行缓存模式发送</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> Dest<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//当前为接收进程</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Recv</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ProcessNum<span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> Src<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ProcessNum<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Buffer["</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">"] = "</span> <span class="token operator">&lt;&lt;</span> Buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">2</span> <span class="token function">MPI8</span><span class="token punctuation">(</span>CacheCommunication<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Buffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
Buffer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">同步通信模式</font></p>
<hr>
<p>同步通信模式的开始不依赖于接收进程相应的接收操作是否已经启动，但是同步发送却必须等到相应的接收进程开始后才可以正确返回。因此，同步发送返回后，意味着发送缓冲区中的数据已经全部被系统缓冲区缓存，并且已经开始发送。这样当同步发送返回后，发送缓冲区可以被释放或重新使用。而在标准通信模式或缓存通信模式中，在用使用缓存的模式下，发送操作返回仅仅意味着数据都已经到发送缓冲区了，数据是否到系统缓冲区不得而知（发送缓冲区表示MPI的缓冲区，系统缓冲区表示操作系统的写缓冲区）。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_10.png?raw=true" alt><br>示例代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SIZE 10</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Src <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Dest <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    MPI_Status Status1<span class="token punctuation">,</span> Status2<span class="token punctuation">;</span>

    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"This program uses exactly 2 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> ActualSize <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> Src<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true">//当前为发送进程</span>
    <span class="token punctuation">{</span>
        ActualSize <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Ssend</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ActualSize<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> Dest<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//同步消息发送1个整型数，消息标签tag为1</span>

        ActualSize <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Ssend</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ActualSize<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> Dest<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//同步消息发送4个整型数，消息标签tag为2</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> Dest<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//当前为接收进程</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Recv</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ActualSize<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> Src<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Recv</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">,</span> ActualSize<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> Src<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status2<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> Count1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Count2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Get_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Status1<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Count1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//获取消息1包含的数据个数</span>
        <span class="token function">MPI_Get_count</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Status2<span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Count2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//获取消息2包含的数据个数</span>

        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Receive "</span> <span class="token operator">&lt;&lt;</span> Count1 <span class="token operator">&lt;&lt;</span> <span class="token string">" data, tag = "</span> <span class="token operator">&lt;&lt;</span> Status1<span class="token punctuation">.</span>MPI_TAG <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Receive "</span> <span class="token operator">&lt;&lt;</span> Count2 <span class="token operator">&lt;&lt;</span> <span class="token string">" data, tag = "</span> <span class="token operator">&lt;&lt;</span> Status2<span class="token punctuation">.</span>MPI_TAG <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">2</span> <span class="token function">MPI9</span><span class="token punctuation">(</span>SyncCommunication<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Receive <span class="token number">1</span> data<span class="token punctuation">,</span> tag <span class="token operator">=</span> <span class="token number">1</span>
Receive <span class="token number">4</span> data<span class="token punctuation">,</span> tag <span class="token operator">=</span> <span class="token number">2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">就绪通信模式</font></p>
<hr>
<p>在就绪通信模式中，只有当接收进程的接收操作已经启动时，才可以在发送端启动发送操作。图示如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_11.png?raw=true" alt><br>一种可能的就绪通信模式的底层实现方式如下图：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_12.png?raw=true" alt><br>目标是保证1要先于4执行，方法是插入2和3：程序上1一定先于2执行，3一定等2成功后才执行（标准模式通信），3成功后4才能执行。所以这样一来就保证了1一定优先于4执行，从而保证就绪通信。</p>
<p>使用就绪通信的示例代码如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> SIZE 2000</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Src <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Dest <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> SendBuf<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">,</span> RecvBuf<span class="token punctuation">[</span>SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    MPI_Request Request<span class="token punctuation">;</span>

    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"This program uses exactly 2 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> NextRank <span class="token operator">=</span> CurrentRank <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>NextRank <span class="token operator">>=</span> ProcessNum<span class="token punctuation">)</span>
        NextRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> PrevRank <span class="token operator">=</span> CurrentRank <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrevRank <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        PrevRank <span class="token operator">=</span> ProcessNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> Tag <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> Count <span class="token operator">=</span> SIZE <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Recv</span><span class="token punctuation">(</span>MPI_BOTTOM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> NextRank<span class="token punctuation">,</span> Tag<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//收到其接收进程通知，表示接收操作已经启动</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">" post Ready send"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Rsend</span><span class="token punctuation">(</span>SendBuf<span class="token punctuation">,</span> Count<span class="token punctuation">,</span> MPI_FLOAT<span class="token punctuation">,</span> NextRank<span class="token punctuation">,</span> Tag<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cout<span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">" post a receive call"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Irecv</span><span class="token punctuation">(</span>RecvBuf<span class="token punctuation">,</span> SIZE<span class="token punctuation">,</span> MPI_FLOAT<span class="token punctuation">,</span> MPI_ANY_SOURCE<span class="token punctuation">,</span> MPI_ANY_TAG<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//启动非阻塞接收</span>
        <span class="token function">MPI_Send</span><span class="token punctuation">(</span>MPI_BOTTOM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> NextRank<span class="token punctuation">,</span> Tag<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">//通知发送进程接收进程的接收操作已经启动</span>
        <span class="token function">MPI_Wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>                                                                <span class="token comment" spellcheck="true">//等待非阻塞接收完成</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">" Receive Rsend message from "</span> <span class="token operator">&lt;&lt;</span> Status<span class="token punctuation">.</span>MPI_SOURCE <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">2</span> <span class="token function">MPI10</span><span class="token punctuation">(</span>ReadyCommutation<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Process <span class="token number">1</span> post a receive call
Process <span class="token number">0</span> post Ready send
Process <span class="token number">1</span> Receive Rsend message from <span class="token number">0</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">阻塞通信与非阻塞通信</font></p>
<hr>
<p>阻塞通信调用时，整个程序只能执行通信相关的内容，而无法执行计算相关的内容。非阻塞调用的初衷是尽量让通信和计算重叠进行，提高程序整体执行效率。如下图所示：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_13.png?raw=true" alt><br>非阻塞通信调用意味着通信开始启动；而非阻塞通信完成则需要调用其他的接口来查询。理想的非阻塞通信设计应该如下：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_15.png?raw=true" alt><br>非阻塞通信对应的发送和接收函数如下图所示：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_14.png?raw=true" alt><br>重复非阻塞通信，表示可以一次完成多个非阻塞调用。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Isend</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Datatype datatype<span class="token punctuation">,</span> <span class="token keyword">int</span> dest<span class="token punctuation">,</span> <span class="token keyword">int</span> tag<span class="token punctuation">,</span>
MPI_Comm comm<span class="token punctuation">,</span> MPI_Request <span class="token operator">*</span>request<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>非阻塞调用的函数比一般对应的阻塞调用函数多了一个参数：request，这个参数是一个用来描述非阻塞通信状况的对象，称为非阻塞通信对象，通过对这一对象的查询，就可以知道与之相应的非阻塞发送是否完成。</p>
<p>非阻塞通信调用的返回并不意味着通信的完成，那么如何才能明确得知该非阻塞通信已经完成了呢？MPI提供两个调用MPI_WAIT和MPI_TEST用于这一目的。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Wait</span><span class="token punctuation">(</span>MPI_Request <span class="token operator">*</span>request<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>MPI_Wait以非阻塞通信对象MPI_Request为参数，一直等到与该阻塞通信对象相应的非阻塞通信完成后才返回，同时释放该非阻塞通信对象，因此程序员就不需要再显式释放该对象。与该非阻塞通信完成有关的信息放在返回的状态参数status中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Test</span><span class="token punctuation">(</span>MPI_Request<span class="token operator">*</span>request<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>MPI_Test与MPI_Wait类似，但是它的返回不一定等到与非阻塞通信对象相联系的非阻塞通信的结束。若在调用MPI_Test时，该非阻塞通信已经结束，则它和MPI_Wait的效果完全相同，完成标志flag=true；若在调用MPI_Test时，该非阻塞通信还未完成，则它和MPI_Wait不同，它不必等待非阻塞通信的完成，可以直接返回，但是完成标志flag=false，同时也不释放相应的非阻塞通信对象。示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> RecevieBuf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> SendBuf <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    MPI_Request Request<span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"This program uses exactly 2 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        SendBuf <span class="token operator">=</span> CurrentRank<span class="token punctuation">;</span>
        <span class="token function">MPI_Isend</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SendBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//标准非阻塞发送</span>
        <span class="token function">MPI_Wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token comment" spellcheck="true">//等待该发送的完成</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process 0 has sended the data."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Irecv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecevieBuf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//标准非阻塞接收</span>
        <span class="token function">MPI_Wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Request<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>                                        <span class="token comment" spellcheck="true">//等待该接收操作的完成</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process 1 has received the data."</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">2</span> <span class="token function">MPI11</span><span class="token punctuation">(</span>NonBlocking<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Process <span class="token number">0</span> has sended the data<span class="token punctuation">.</span>
Process <span class="token number">1</span> has received the data<span class="token punctuation">.</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>因为可以在一个进程中调用MPI_Send_Init函数来多次发送非阻塞通信，所以也有对应的Wait和Test函数来检测这多次非阻塞通信的完成状态：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Waitany</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Request <span class="token operator">*</span>array_of_requests<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>index<span class="token punctuation">,</span>
MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>该函数用于等待非阻塞通信对象中任何一个非阻塞通信对象的完成，然后释放已完成的非阻塞通信对象，然后返回，返回后index= i，表示第i个非阻塞通信完成了。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Waitall</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Request <span class="token operator">*</span>array_of_requests<span class="token punctuation">,</span>
MPI_Status <span class="token operator">*</span>array_of_statuses<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>该函数必须等到所有非阻塞通信对象对应的非阻塞通信操作都完成后才返回。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Waitsome</span><span class="token punctuation">(</span><span class="token keyword">int</span> incount<span class="token punctuation">,</span>MPI_Request <span class="token operator">*</span>array_of_request<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>outcount<span class="token punctuation">,</span>
<span class="token keyword">int</span> <span class="token operator">*</span>array_of_indices<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>array_of_statuses<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>该函数只要有一个或多个非阻塞通信完成就会返回。已完成非阻塞通信的个数记录在outcount中，它们的下标和状态分别记录在后两个参数里。</p>
<p>当然也有对应的Test函数（含义类似不再赘述了）：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Testany</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Request <span class="token operator">*</span>array_of_requests<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>index<span class="token punctuation">,</span>
<span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Testall</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Request <span class="token operator">*</span>array_of_requests<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">,</span>
MPI_Status <span class="token operator">*</span>array_of_statuses<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Testsome</span><span class="token punctuation">(</span><span class="token keyword">int</span> incount<span class="token punctuation">,</span>MPI_Request <span class="token operator">*</span>array_of_request<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>outcount<span class="token punctuation">,</span>
<span class="token keyword">int</span> <span class="token operator">*</span>array_of_indices<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>array_of_statuses<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>还可以用MPI_Probe和MPI_IProbe函数，来允许程序员在不实际执行接收的情况下，检查给定的消息是否到达。程序员可以根据返回的信息决定如何接收该消息，甚至可以根据被检查消息的长度来分配缓冲区的大小：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Iprobe</span><span class="token punctuation">(</span><span class="token keyword">int</span> source<span class="token punctuation">,</span><span class="token keyword">int</span> tag<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">,</span> MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数是一个非阻塞调用，用于检查来源于通信子comm里进程号为source、标签为tag的消息是否到达，如果到达了flag为true，否则为false。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Probe</span><span class="token punctuation">(</span><span class="token keyword">int</span> source<span class="token punctuation">,</span><span class="token keyword">int</span> tag<span class="token punctuation">,</span>MPI_Comm comm<span class="token punctuation">,</span>MPI_Status <span class="token operator">*</span>status<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数是一个阻塞调用，只有找到一个匹配的消息达到之后它才会返回。<br>示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> RecvI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> RecvD <span class="token operator">=</span> <span class="token number">41.41</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProcessNum <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"This program uses exactly 3 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecvI<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecvD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">MPI_Probe</span><span class="token punctuation">(</span>MPI_ANY_SOURCE<span class="token punctuation">,</span> MPI_ANY_TAG<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>MPI_SOURCE<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">MPI_Recv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecvI<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Data: "</span> <span class="token operator">&lt;&lt;</span> RecvI <span class="token operator">&lt;&lt;</span> <span class="token string">" from process 0"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> Status<span class="token punctuation">.</span>MPI_SOURCE<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token function">MPI_Recv</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecvD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Data: "</span> <span class="token operator">&lt;&lt;</span> RecvD <span class="token operator">&lt;&lt;</span> <span class="token string">" from process 1"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">3</span> <span class="token function">MPI12</span><span class="token punctuation">(</span>Probe<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Data<span class="token operator">:</span> <span class="token number">0</span> from process <span class="token number">0</span>
Data<span class="token operator">:</span> <span class="token number">41.41</span> from process <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">MPI发送不连续数据</font></p>
<hr>
<p>其实这节也可以叫做如何用MPI发送用户自定义的数据类型。因为用户自定义的结构体等数据类型，通常都具有内部数据类型不完全一致、数据不连续的特性。</p>
<p>MPI处理不连续数据有两种方法：</p>
<ul>
<li>允许用户把不连续的多个数据类型封装成自定义的新的数据类型（又称派生数据类型），然后使用这种新的数据类型来发送不连续的数据。</li>
<li>数据的打包和解包。即在发送方将不连续的数据打包到连续的区域，然后发送出去；在接收方将打包后的连续数据再解包到不连续的存储空间。</li>
</ul>
<p><font size="5" color="orange">用户自定义新的数据类型</font></p>
<hr>
<p>比如现在有一个结构体是这样的：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> SData
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token keyword">char</span>   c<span class="token punctuation">;</span>
<span class="token punctuation">}</span> Data<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>MPI不能直接把这个结构体发送出去，因为在类似MPI_Send这类函数里，指定数据内容的同时，需要指定数据的类型，但是这个数据的类型又必须是像MPI_INT这种专属于MPI的类型。当然这个结构体类型肯定没有对应的MPI类型，所以我们需要为MPI自定义一个类似这个结构体的类型，然后用这个新的类型来发送结构体数据：</p>
<p>MPI使用类型图来表示一个自定义数据类型的结构：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">类型图<span class="token operator">=</span><span class="token punctuation">{</span><span class="token operator">&lt;</span>类型<span class="token number">0</span><span class="token punctuation">,</span>偏移<span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>类型<span class="token number">1</span><span class="token punctuation">,</span>偏移<span class="token number">1</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>类型<span class="token number">2</span><span class="token punctuation">,</span>偏移<span class="token number">2</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token operator">&lt;</span>类型n<span class="token number">-1</span><span class="token punctuation">,</span>偏移n<span class="token number">-1</span><span class="token operator">></span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>那么上面的结构体的类型图就是（要注意结构体等数据类型的对齐问题）：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token operator">></span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>了解数据的类型图在于我们要清楚地认识到，在MPI中定义一个复杂的数据类型需要明确告知其成员类型和内存偏移。</p>
<p>我们可以用MPI_Type_create_struct函数来创建结构体SData对应的自定义MPI类型：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_struct</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>array_of_blocklengths<span class="token punctuation">,</span> MPI_Aint <span class="token operator">*</span>array_of_displacements<span class="token punctuation">,</span>
MPI_Datatype <span class="token operator">*</span>array_of_types <span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>需要提供块的数量count（块通常都是连续的相同类型组合在一起，比如我们通常认为{&lt;double,0&gt;, &lt;double,8&gt;, &lt;char, 16&gt;}是两个不同的块构成的类型图，前两个double型构成一个块，后一个char型构成一个块，所以对于SData就是两个块组成的）、各个块的长度\元素个数array_of_blocklengths（刚才的例子就是前一个块长度为2，后一个块长度为1）、各个块的起始地址的偏移字节数array_of_displacements、各个块中的元素类型array_of_types 、新数据类型newtype。</p>
<p>比如对于结构体SData，块数量为2、各个块长度为{1,1}、各个块偏移量为{0,8}、各个块类型为{double,char}，所以我们可以用如下代码来创建对应的MPI类型：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> BlockLens<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
MPI_Aint BlockDisplacements<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
MPI_Datatype BlockDatatypes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> MPI_DOUBLE<span class="token punctuation">,</span>MPI_CHAR <span class="token punctuation">}</span><span class="token punctuation">;</span>
MPI_Datatype NewStructType<span class="token punctuation">;</span>
<span class="token function">MPI_Type_create_struct</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> BlockLens<span class="token punctuation">,</span> BlockDisplacements<span class="token punctuation">,</span> BlockDatatypes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//生成新的MPI结构体数据类型</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>NewStructType就是我们为SData生成的对应的MPI类型。<br>这个新类型在使用之前，还必须先使用MPI_Type_commit函数将其递交给MPI系统。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">MPI_Type_commit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>一个递交后的数据类型，就可以当作一个MPI基本类型了，甚至可以用它去生成别的数据类型。也就是说比如我们现在有了一个已经递交的MPI类型type1，它的类型图恰好是{&lt;double,0&gt;, &lt;char, 8&gt;}，那么SData就可以直接由这一个块来组成，不用再分成两个块了。不过通常情况下，这样做会比较麻烦，因为需要先生成、递交中间数据类型type1，所以我们才通常把连续的基本类型数据作为一个块。</p>
<p>接下来我们就可以用NewStructType这个新的MPI类型，来直接发送、接收SData对象了：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">41.41</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MPI_Bcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NewStructType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">" received the struct data: "</span> <span class="token operator">&lt;&lt;</span> Data<span class="token punctuation">.</span>d <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> Data<span class="token punctuation">.</span>c <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>使用完新类型以后别忘了使用MPI_Type_free函数释放它：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">MPI_Type_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>完整程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;mpi.h></span></span>

<span class="token keyword">struct</span> SData
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token keyword">char</span>   c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>Data<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> BlockLens<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    MPI_Aint BlockDisplacements<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    BlockDisplacements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    BlockDisplacements<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*MPI_Get_address(&amp;Data.d, &amp;BlockDisplacements[0]);
    MPI_Get_address(&amp;Data.c, &amp;BlockDisplacements[1]);
    BlockDisplacements[1] -= BlockDisplacements[0];
    BlockDisplacements[0] = 0;*/</span>
    MPI_Datatype BlockDatatypes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> MPI_DOUBLE<span class="token punctuation">,</span>MPI_CHAR <span class="token punctuation">}</span><span class="token punctuation">;</span>
    MPI_Datatype NewStructType<span class="token punctuation">;</span>
    <span class="token function">MPI_Type_create_struct</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> BlockLens<span class="token punctuation">,</span> BlockDisplacements<span class="token punctuation">,</span> BlockDatatypes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//生成新的MPI结构体数据类型</span>
    <span class="token function">MPI_Type_commit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Data <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">41.41</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> NewStructType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//直接使用新的MPI类型来发送结构体数据</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">" received the struct data: "</span> <span class="token operator">&lt;&lt;</span> Data<span class="token punctuation">.</span>d <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> Data<span class="token punctuation">.</span>c <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

    <span class="token function">MPI_Type_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NewStructType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的0和8是我们自己人为算出的偏移量，有时候可能会比较麻烦或者拿不准，我们可以直接使用MPI_Adress函数来获取到这些偏移量：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Get_address</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> location<span class="token punctuation">,</span> MPI_Aint <span class="token operator">*</span>address<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回一个变量在内存中相对于MPI预定义的地址MPI_BOTTOM的偏移地址。所以我们可以用如下代码来获取结构体对象Data中两个变量的偏移地址：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">MPI_Aint BlockDisplacements<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">MPI_Get_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BlockDisplacements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MPI_Get_address</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">.</span>c<span class="token punctuation">,</span> <span class="token operator">&amp;</span>BlockDisplacements<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
BlockDisplacements<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> BlockDisplacements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
BlockDisplacements<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><br><br>使用MPI_Type_struct函数可以生成MPI结构体类型，还有一些其他函数可以生成一些别的MPI类型：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_contiguous</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> MPI_Datatype oldtype<span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于生成连续的数据类型，相当于将一个已有的数据类型按顺序依次连续进行复制后的结果。例如如果原来的数据类型oldtype的类型图为{&lt;double,0&gt;, &lt;char,8&gt;}，对旧类型重复的次数count=3，则newtype返回的新类型的类型图为：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token operator">></span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><br></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_vector</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">int</span> blocklength<span class="token punctuation">,</span> <span class="token keyword">int</span> stride<span class="token punctuation">,</span> MPI_Datatype oldtype<span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数和MPI_Type_contiguous函数类似，只不过后者是把数据类型进行连续复制，而该函数是连续复制count个块，每个块有blocklength个元素，每个元素的类型是oldtype；而且块与块之间可以存在空隙，两个相邻块的各自第一个元素之间相隔stride个元素。例如oldtype的类型图是{&lt;double, 0&gt;, &lt;char,8&gt;}，则调用<code>MPI_Type_vector(2, 3, 4, oldtype, newtype)</code>生成的新数据类型newtype的类型图为：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">24</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token operator">></span><span class="token punctuation">,</span>    <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token operator">></span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>如下图所示：<br><img src="https://github.com/Popperelay/Photos/blob/master/Photos/MPI_16.png?raw=true" alt><br>图中黄色部分表示double，红色部分表示char。<br><br></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_hvector</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">int</span> blocklength<span class="token punctuation">,</span>MPI_Aint stride<span class="token punctuation">,</span>MPI_Datatype oldtype<span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数与上一个函数基本相同，只是stride不再是元素个数，而是字节数。<br><br></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_indexed</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>array_of_blocklengths<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>array_of_displacements<span class="token punctuation">,</span> MPI_Datatype oldtype<span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数也和MPI_Type_vector函数很相似，不同的是它可以单独指定每个块的偏移量，而不是像<br>MPI_Type_vector里只是指定了相邻两个块的距离，而且每个块的长度可以不一样。count是块的数量，array_of_blocklengths是每个块的元素个数，array_of_displacements是每个块的偏移（整数数组，表示偏移量是元素大小的整数倍），oldtype是每个元素的类型，newtype是生成的新的数据类型。假设oldtype的类型图是{&lt;double,0&gt;, &lt;char,8&gt;}，令B={3,1}，D={4,0}，则调用MPI_Type_indexed(2,B,D,oldtype,newtype)生成的新数据类型的类型图是：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token punctuation">{</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">64</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">80</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">96</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token operator">></span><span class="token punctuation">,</span>  <span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token operator">></span><span class="token punctuation">,</span><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token operator">></span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><br></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Type_hindexed</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>array_of_blocklengths<span class="token punctuation">,</span> MPI_Aint<span class="token operator">*</span> array_of_displacements<span class="token punctuation">,</span> MPI_Datatype oldtype<span class="token punctuation">,</span> MPI_Datatype <span class="token operator">*</span>newtype<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数和上一个函数基本相同，只是array_of_displacements中的块偏移不再是旧数据类型大小的整数倍，而是字节数。</p>
<p><font size="5" color="orange">打包与解包</font></p>
<hr>
<p>打包和解包是除了自定义数据类型以外，另一个用来发送不连续数据的方式，在发送前显式地把数据包装到一个连续的缓冲区，在接收之后从连续缓冲区中解包。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Pack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> inbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> incount<span class="token punctuation">,</span> MPI_datatype<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>outbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> outcount<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>position<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数把发送缓冲区inbuf里的incount个datatype类型的数据放到输出缓冲区outbuf里，该输出缓冲区共有outcount个字节。position指定了把发送缓冲区的数据放置于输出缓冲区的第几个元素上（position是一个表示元素个数的整型，结合datatype就能算出其在输出缓冲区里的地址），调用完该函数后，position的值会按照被打包数据的个数来增加。</p>
<p>由position值的变化方式决定，通过连续几次对不同位置的消息调用该打包操作，就可以将不连续的数据放到一个连续的空间。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Unpack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> inbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> insize<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>position<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>outbuf<span class="token punctuation">,</span> <span class="token keyword">int</span> outcount<span class="token punctuation">,</span> MPI_Datatype datatype<span class="token punctuation">,</span> MPI_Comm comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数与MPI_Pack函数对应，输入缓冲区inbuf是一个具有insize个元素位置的连续空间，position指定了将要被解包的数据在连续的输入缓冲区的第几个元素位置上（整型，结合datatype就可以算出其地址），解包后它的值根据解包数据的个数来增加，因此连续多次调用MPI_Unpack函数，就可以把连续的数据解包到不同（不连续）的输出缓存outbuf中。</p>
<p>打包后的数据可以用MPI_PACKED格式发送出去。接收方可以用MPI_PACKED格式来接收数据，然后调用MPI_Unpack来解包数据；也可以直接用MPI_INT这种类似的准确类型来接收，相当于自动解包了，只要和发送方发送的实际数据类型确实匹配就可以了。</p>
<p>下面我们用打包和解包的方式来发送一个结构体，示例程序如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//通过打包和解包来发送结构体等等这些复杂的或者不连续的数据</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"mpi.h"</span></span>

<span class="token keyword">struct</span> SData
<span class="token punctuation">{</span>
    <span class="token keyword">double</span> d<span class="token punctuation">;</span>
    <span class="token keyword">char</span>   c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>Data<span class="token punctuation">{</span> <span class="token number">41.41</span><span class="token punctuation">,</span><span class="token string">'a'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> Position4Pack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> Position4Unpack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> ContinusBuf<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Pack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> ContinusBuf<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Position4Pack<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//将结构体对象Data的成员d打包到连续空间ContinusBuf里</span>
        <span class="token function">MPI_Pack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Data<span class="token punctuation">.</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_CHAR<span class="token punctuation">,</span> ContinusBuf<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>Position4Pack<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment" spellcheck="true">//接着将结构体对象Data的成员c打包到连续空间ContinusBuf里</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Position4Pack<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span>ContinusBuf<span class="token punctuation">,</span> Position4Pack<span class="token punctuation">,</span> MPI_PACKED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        SData Data2<span class="token punctuation">;</span>
        Position4Unpack <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Unpack</span><span class="token punctuation">(</span>ContinusBuf<span class="token punctuation">,</span> Position4Pack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Position4Unpack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Data2<span class="token punctuation">.</span>d<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//将连续空间里的第一个元素解包到Data2.d里</span>
        <span class="token function">MPI_Unpack</span><span class="token punctuation">(</span>ContinusBuf<span class="token punctuation">,</span> Position4Pack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Position4Unpack<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Data2<span class="token punctuation">.</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> MPI_DOUBLE<span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//将连续空间里的第二个元素解包到Data2.c里</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Data2 = {"</span> <span class="token operator">&lt;&lt;</span> Data2<span class="token punctuation">.</span>d <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> Data2<span class="token punctuation">.</span>c <span class="token operator">&lt;&lt;</span> <span class="token string">"}"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">4</span> <span class="token function">MPI14</span><span class="token punctuation">(</span>Pack<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Data2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">41.41</span><span class="token punctuation">,</span> a<span class="token punctuation">}</span>
Data2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">41.41</span><span class="token punctuation">,</span> a<span class="token punctuation">}</span>
Data2 <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">41.41</span><span class="token punctuation">,</span> a<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><font size="5" color="orange">MPI的进程组和通信域</font></p>
<hr>
<p>通信域包括通信上下文、进程组、虚拟处理器拓扑、属性等内容，可分为组内通信域和组间通信域。组内通讯域用于描述属于同一组内进程间的通信，组间通讯域用于描述属于不同进程组的进程间的通信。</p>
<p>进程组是通讯域的一个重要组成部分，它定义了不同进程的有序集合，进程组内的每个进程都有一个序号rank，它们的序号是从0开始编号并且连续的。</p>
<p><font size="5" color="orange">进程组的管理</font></p>
<hr>
<p>我们先来看一些与进程组有关的管理函数：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_size</span><span class="token punctuation">(</span>MPI_Group group<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>size<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回进程中group中所包含的进程数size。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_rank</span><span class="token punctuation">(</span>MPI_Group group<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>rank<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回当前进程在进程组group中的编号，有点像MPI_Comm_rank。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_translate_ranks</span><span class="token punctuation">(</span>MPI_Group group1<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>ranks1<span class="token punctuation">,</span> MPI_Group group2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>ranks2<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回进程组group1中的n个进程（由ranks指定）在进程组group2中对应的编号（把对应的编号放到ranks2里）。比如有的时候想要知道MPI_COMM_WORLD中的某些进程，在MPI_COMM_WORLD子通信域（子进程组）中对应的序号。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_compare</span><span class="token punctuation">(</span>MPI_Group group1<span class="token punctuation">,</span>MPI_Group group2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>result<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数对两个进程组group1和group2进行比较，如果两个进程组所包含的进程以及相同进程的编号都完全相同，则返回MPI_IDENT；如果所包含的进程完全相同但是相同进程的编号在两个组中并不相同，则返回MPI_SIMILAR；否则返回MPI_UNEQUAL。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_group</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span> MPI_Group <span class="token operator">*</span> group<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回通讯域comm中所包含的进程组group。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_union</span><span class="token punctuation">(</span>MPI_Group group1<span class="token punctuation">,</span> MPI_Group group2<span class="token punctuation">,</span> MPI_Group <span class="token operator">*</span>newgroup<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回两个进程组的并集。该并集中的元素次序是第一组中的元素次序后跟第二组中出现的元素。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_intersection</span><span class="token punctuation">(</span>MPI_Group group1<span class="token punctuation">,</span> MPI_Group group2<span class="token punctuation">,</span> MPI_Group <span class="token operator">*</span>newgroup<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回两个进程组的交集。该交集中的元素次序同第一组。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_difference</span><span class="token punctuation">(</span>MPI_Group group1<span class="token punctuation">,</span>MPI_Group group2<span class="token punctuation">,</span>MPI_Group <span class="token operator">*</span>newgroup<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回第一个进程组group1对第二个进程组group2的差集。该差集中的元素次序同第一组。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_incl</span><span class="token punctuation">(</span>MPI_Group group<span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>ranks<span class="token punctuation">,</span>MPI_Group <span class="token operator">*</span>newgroup<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数将已有进程组group中的n个进程（由ranks指定）形成一个新的进程组newgroup。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_excl</span><span class="token punctuation">(</span>MPI_Group group<span class="token punctuation">,</span> <span class="token keyword">int</span> n <span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>ranks<span class="token punctuation">,</span>MPI_Group <span class="token operator">*</span>newgroup<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数是将已有进程组group中的n个进程（由ranks指定）删除后形成新的进程组newgroup。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Group_free</span><span class="token punctuation">(</span>MPI_Group <span class="token operator">*</span>group<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于释放一个已有的进程组，然后把group置为MPI_GROUP_NULL，任何正在使用此组的操作将正常完成。</p>
<p><font size="5" color="orange">通讯域的管理</font></p>
<hr>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>size<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回通信域comm中的进程数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>rank<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回当前进程在通讯域comm中的编号rank。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_compare</span><span class="token punctuation">(</span>MPI_Comm comm1<span class="token punctuation">,</span>MPI_Comm comm2<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>result<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于比较两个通信域。如果comm1和comm2是同一对象的句柄（指针），返回MPI_IDENT；如果它俩包含的进程组的成员和序列编号都相同，则返回MPI_CONGRUENT；如果进程组的成员相同但编号不同，则返回MPI_SIMILAR；否则返回MPI_UNEQUAL。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_dup</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span>MPI_Comm <span class="token operator">*</span>newcomm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于对一个已有的通信域comm进行复制，得到一个新的通信域newcomm。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_create</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span>MPI_Group group<span class="token punctuation">,</span>MPI_Comm <span class="token operator">*</span>newcomm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数根据通信域comm所包含的进程组的子集group，来创建一个新的通信域newcomm。如果当前进程不在group里，该函数调用会返回MPI_COMM_NULL（因为通常都是每个进程都会调用这个函数）。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_split</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span><span class="token keyword">int</span> color<span class="token punctuation">,</span> <span class="token keyword">int</span> key<span class="token punctuation">,</span>MPI_Comm <span class="token operator">*</span>newcomm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数太复杂了，没看懂。。。好像是把具有相同color的进程合在一起形成新的通信域，每个新的通信域中按照进程的key来排序。具体请参考《高性能计算之并行编程技术— MPI 并行程序设计》一书P189页把。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_free</span><span class="token punctuation">(</span>MPI_Comm <span class="token operator">*</span>comm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于释放通信域comm，释放后该通信域被置为MPI_COMM_NULL。任何使用此通信域的挂起操作都会正常完成，仅当没有对此对象的活动引用时，它才会被实际撤销。</p>
<p><font size="5" color="orange">通信域和进程组管理的程序示例</font></p>
<hr>
<p>比如现在有6个，在MPI_COMM_WORLD中的编号是{0,1,2,3,4,5}，现在需要用{1,3,5}形成新的通信域comm1，用{0,2,4}形成新的通信域comm2，然后在comm1中指向MAX归约操作，在comm2中执行MIN归约操作，在MPI_COMM_WORLD中执行SUM归约操作：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"mpi.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ProcessNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> CurrentRank4CommWorld<span class="token punctuation">;</span>
    <span class="token keyword">int</span> SendBuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//4个进程会分别发送不同的数据</span>
    <span class="token keyword">int</span> RecevieBuf1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> RecevieBuf2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> RecevieBuf3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_size</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ProcessNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank4CommWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">!=</span> ProcessNum<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Please specify 6 processes!"</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">MPI_Abort</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    MPI_Group WorldGroup<span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_group</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>WorldGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment" spellcheck="true">//获取通信域MPI_COMM_WORLD包含的进程组</span>
    <span class="token keyword">int</span> Ranks<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    MPI_Group NewGroup1<span class="token punctuation">,</span> NewGroup2<span class="token punctuation">;</span>
    <span class="token function">MPI_Group_incl</span><span class="token punctuation">(</span>WorldGroup<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Ranks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewGroup1<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">//用WorldGroup中的1,3这两个进程组成新的进程组NewGroup1</span>
    <span class="token function">MPI_Group_excl</span><span class="token punctuation">(</span>WorldGroup<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Ranks<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewGroup2<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment" spellcheck="true">//用WorldGroup中的0,2这两个进程组成新的进程组NewGroup2</span>

    MPI_Comm NewComm1<span class="token punctuation">,</span> NewComm2<span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_create</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> NewGroup1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">//用NewGroup1构造新的通信域NewComm1，当前进程不在NewGroup1里时会创建失败，返回MPI_COMM_NULL</span>
    <span class="token function">MPI_Comm_create</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> NewGroup2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewComm2<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment" spellcheck="true">//用NewGroup2构造新的通信域NewComm2，当前进程不在NewGroup2里时会创建失败，返回MPI_COMM_NULL</span>

    <span class="token keyword">int</span> OldRank1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> OldRank2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> NewCommRoot1<span class="token punctuation">,</span> NewCommRoot2<span class="token punctuation">;</span>

    <span class="token function">MPI_Group_translate_ranks</span><span class="token punctuation">(</span>WorldGroup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OldRank1<span class="token punctuation">,</span> NewGroup1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewCommRoot1<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//获取WorldGroup中序号为1的进程在新进程组NewGroup1中的编号，后面发送数据时会将其作为新进程组的根进程</span>
    <span class="token function">MPI_Group_translate_ranks</span><span class="token punctuation">(</span>WorldGroup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OldRank2<span class="token punctuation">,</span> NewGroup2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>NewCommRoot2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//获取WorldGroup中序号为0的进程在新进程组NewGroup2中的编号，后面发送数据时会将其作为新进程组的根进程</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>MPI_COMM_NULL <span class="token operator">!=</span> NewComm1<span class="token punctuation">)</span>                                                    <span class="token comment" spellcheck="true">//这个if判断很重要，因为下面花括号里面的代码只在NewComm1非空时才有效</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Reduce</span><span class="token punctuation">(</span>SendBuf<span class="token punctuation">[</span>CurrentRank4CommWorld<span class="token punctuation">]</span><span class="token punctuation">,</span> RecevieBuf1<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> MPI_MAX<span class="token punctuation">,</span> NewCommRoot1<span class="token punctuation">,</span> NewComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> CurrentRank1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>NewComm1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NewCommRoot1 <span class="token operator">==</span> CurrentRank1<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank4CommWorld <span class="token operator">&lt;&lt;</span> <span class="token string">":\t"</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> RecevieBuf1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>MPI_COMM_NULL <span class="token operator">!=</span> NewComm2<span class="token punctuation">)</span>                                                <span class="token comment" spellcheck="true">//这个if判断很重要，因为下面花括号里面的代码只在NewComm2非空时才有效</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Reduce</span><span class="token punctuation">(</span>SendBuf<span class="token punctuation">[</span>CurrentRank4CommWorld<span class="token punctuation">]</span><span class="token punctuation">,</span> RecevieBuf2<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> MPI_MIN<span class="token punctuation">,</span> NewCommRoot2<span class="token punctuation">,</span> NewComm2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> CurrentRank2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>NewComm2<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>NewCommRoot2 <span class="token operator">==</span> CurrentRank2<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank4CommWorld <span class="token operator">&lt;&lt;</span> <span class="token string">":\t"</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
                std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> RecevieBuf2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">MPI_Reduce</span><span class="token punctuation">(</span>SendBuf<span class="token punctuation">[</span>CurrentRank4CommWorld<span class="token punctuation">]</span><span class="token punctuation">,</span> RecevieBuf3<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> MPI_SUM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank4CommWorld<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Process "</span> <span class="token operator">&lt;&lt;</span> CurrentRank4CommWorld <span class="token operator">&lt;&lt;</span> <span class="token string">":\t"</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> RecevieBuf3<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\t"</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>程序运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">4</span> <span class="token function">MPI15</span><span class="token punctuation">(</span>CommAndGroupManagement<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Process <span class="token number">0</span><span class="token operator">:</span>      <span class="token number">1</span>       <span class="token number">2</span>       <span class="token number">2</span>       <span class="token number">1</span>
Process <span class="token number">1</span><span class="token operator">:</span>      <span class="token number">4</span>       <span class="token number">3</span>       <span class="token number">4</span>       <span class="token number">3</span>
Process <span class="token number">0</span><span class="token operator">:</span>      <span class="token number">10</span>      <span class="token number">10</span>      <span class="token number">11</span>      <span class="token number">9</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面的程序里指定只能运行4个进程，每个进程发送SendBuf里不同的内容，用{1,3}号进程创建新的通信域NewComm1，用{0,2}号进程创建新的通信域NewComm2。在通信域NewComm1里，原1号进程发送数据{4,3,2,1}，原3号进程发送数据{2,1,4,3}，所以做MPI_MAX归约操作以后，进程1会输出上面的：4,3,4,3。在通信域NewComm2里，原0号进程发送数据{1,2,3,4}，原2号进程发送数据{3,4,2,1}，所以做MPI_MIN归约操作以后，进程0会输出上面的1,2,2,1。在通信域MPI_COMM_WORLD里，进程0到进程3分别发送数据：{ 1,2,3,4 }、{ 4,3,2,1 }、{ 3,4,2,1 }、{ 2,1,4,3 }，所以做MIN_SUM归约操作以后，进程0会输出上面的10,10,11,9。</p>
<p><font size="5" color="orange">组间通信域</font></p>
<hr>
<p>组间通信域是一种特殊的通信域，该通信域包括两个进程组，通过组间通信域实现两个不同进程组内进程之间的通信。一般把调用进程所在的进程组叫做本地组，而把另一个组叫做远程组。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_test_inter</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>flag<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于判断给定的通信域是组内通信域还是组间通信域，如果是组间通信域则返回true，否则返回false。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_COMM_Comm_remote_size</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span><span class="token keyword">int</span> <span class="token operator">*</span>size<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回组间通信域内远程进程组的进程个数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Comm_remote_group</span><span class="token punctuation">(</span>MPI_Comm comm<span class="token punctuation">,</span>MPI_Group <span class="token operator">*</span>group<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数用于返回组间通信域中的远程进程组。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Intercomm_create</span><span class="token punctuation">(</span>MPI_Comm local_comm<span class="token punctuation">,</span><span class="token keyword">int</span> local_leader<span class="token punctuation">,</span>MPI_Comm peer_comm<span class="token punctuation">,</span><span class="token keyword">int</span> remote_leader<span class="token punctuation">,</span><span class="token keyword">int</span> tag<span class="token punctuation">,</span>MPI_Comm <span class="token operator">*</span>newintercomm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数使用两个通信域local_comm和peer_comm创建了一个组间通信域。在同一个本地通信域local_comm中的所有进程，都提供相同的根进程编号local_leader，同时提供相同的远程通信域的根进程编号remote_leader。组成组间通信域的所有进程都必须提供相同的tag。通常远程通信域peer_comm都是使用MPI_COMM_WORLD来代替，也就是说如果comm1和MPI_COMM_WORLD组成组间通信域InterComm1，comm2和MPI_COMM_WORLD组成组间通信域InterComm2，而且创建两个组间通信域时都使用了相同的tag，那么comm1和comm2就能相互通信（MPI_COMM_WORLD就像起到了桥梁作用，这样做的原因是每个进程通常都只能获取到自己进程所在的通信域，得不到其他通信域，所以无法直接用comm1和comm2组成组间通信域，而需要分别在两个不同的进程中使用MPI_COMM_WORLD来作桥梁，可以参考下面的程序示例）。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">MPI_Intercomm_merge</span><span class="token punctuation">(</span>MPI_Comm intercomm<span class="token punctuation">,</span><span class="token keyword">int</span> high<span class="token punctuation">,</span>MPI_Comm <span class="token operator">*</span>newintracomm<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>该函数将一个组间通信域intercomm包含的两个通信域合并，形成一个组内通信域newintracomm。对于组间通信域中的两个进程组，如果一个组内的所有进程都提供high=true，另一个组内的所有进程都提供high=false，则提供true值的组的进程的编号在前，另一个组的编号在后。如果两个组的进程都提供相同的high值，则新通信域中进程的编号是任意的。</p>
<p><font size="5" color="orange">组间通信域程序示例</font></p>
<hr>
<p>我们现在需要将通信域MPI_COMM_WORLD分裂成三个通信域，也就有三个进程组，然后让组0和组1通信，组1和组2通信，在构成组间通信域时需要借助MPI_COMM_WORLD：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">//创建组间通信域，实现不同组内通信域里的进程之间可以相互通信</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"mpi.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> Tag_InterComm01 0</span>
<span class="token macro property">#<span class="token directive keyword">define</span> Tag_InterComm12 1</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> CurrentRank <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    MPI_Comm LocalComm<span class="token punctuation">;</span>                                                                         <span class="token comment" spellcheck="true">//标识当前进程属于分裂后的哪一个组内通信域</span>
    MPI_Comm InterComm1 <span class="token operator">=</span> MPI_COMM_NULL<span class="token punctuation">,</span> InterComm2 <span class="token operator">=</span> MPI_COMM_NULL<span class="token punctuation">;</span>                         <span class="token comment" spellcheck="true">//组间通信域</span>
    <span class="token function">MPI_Init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_rank</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>CurrentRank<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> Color <span class="token operator">=</span> CurrentRank <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">MPI_Comm_split</span><span class="token punctuation">(</span>MPI_COMM_WORLD<span class="token punctuation">,</span> Color<span class="token punctuation">,</span> CurrentRank<span class="token punctuation">,</span> <span class="token operator">&amp;</span>LocalComm<span class="token punctuation">)</span><span class="token punctuation">;</span>                             <span class="token comment" spellcheck="true">//如果输入的进程数是9，则{0,3,6}、{1,4,7}、{2,5,8}构成分裂后的新的进程组(新的组内通信域)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> Color<span class="token punctuation">)</span>                                                                             <span class="token comment" spellcheck="true">//进入if的进程都属于组0，因为color是0的所有进程都被分到组0里</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Intercomm_create</span><span class="token punctuation">(</span>LocalComm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Tag_InterComm01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//间接生成组0和组1之间的组间通信域InterComm1，使用标识Tag_InterComm01</span>
                                                                                             <span class="token comment" spellcheck="true">//组0中的根进程在LocalComm中编号是0，而组1的根进程在原MPI_COMM_WORLD通信域里编号是1（{1,4,7}构成组1）</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> Color<span class="token punctuation">)</span>                                                                     <span class="token comment" spellcheck="true">//进入if的进程都属于组1，因为color是1的所有进程都被分到组1里</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Intercomm_create</span><span class="token punctuation">(</span>LocalComm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Tag_InterComm01<span class="token punctuation">,</span> <span class="token operator">&amp;</span>InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//间接生成组1和组0之间的组间通信域InterComm1，使用标识Tag_InterComm01</span>
                                                                                             <span class="token comment" spellcheck="true">//组1中的根进程在LocalComm中编号是0，而组0的根进程在原MPI_COMM_WORLD通信域里编号是0（{0,3,6}构成组1）</span>
        <span class="token function">MPI_Intercomm_create</span><span class="token punctuation">(</span>LocalComm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> Tag_InterComm12<span class="token punctuation">,</span> <span class="token operator">&amp;</span>InterComm2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//间接生成组1和组2之间的组间通信域InterComm2，使用标识Tag_InterComm12</span>
                                                                                             <span class="token comment" spellcheck="true">//组1中的根进程在LocalComm中编号是0，而组2的根进程在原MPI_COMM_WORLD通信域里编号是2（{2,5,8}构成组2）</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">==</span> Color<span class="token punctuation">)</span>                                                                     <span class="token comment" spellcheck="true">//进入if的进程都属于组2，因为color是2的所有进程都被分到组2里</span>
    <span class="token punctuation">{</span>
        <span class="token function">MPI_Intercomm_create</span><span class="token punctuation">(</span>LocalComm<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MPI_COMM_WORLD<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> Tag_InterComm12<span class="token punctuation">,</span> <span class="token operator">&amp;</span>InterComm2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//间接生成组1和组2之间的组间通信域InterComm2，使用标识Tag_InterComm12</span>
                                                                                             <span class="token comment" spellcheck="true">//组2中的根进程在LocalComm中编号是0，而组1的根进程在原MPI_COMM_WORLD通信域里编号是1（{1,4,7}构成组1）</span>
    <span class="token punctuation">}</span>

    MPI_Request Request<span class="token punctuation">;</span>
    MPI_Status Status<span class="token punctuation">;</span>
    <span class="token keyword">int</span> DataBuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>CurrentRank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">41</span><span class="token punctuation">;</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
        DataBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">43</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>InterComm1 <span class="token operator">!=</span> MPI_COMM_NULL<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> Color<span class="token punctuation">)</span>                                                                        <span class="token comment" spellcheck="true">//组间广播通信时，组0只有根进程可以发消息，而且根进程要用MPI_ROOT来指定，其他进程都不能发消息</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> CurrentRank<span class="token punctuation">)</span>
                <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> MPI_ROOT<span class="token punctuation">,</span> InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">==</span> Color<span class="token punctuation">)</span>                                                                <span class="token comment" spellcheck="true">//组间广播通信时，组1使用MPI_Bcast接收消息时，root应该是发送方组0的进程号</span>
        <span class="token punctuation">{</span>
            <span class="token function">MPI_Bcast</span><span class="token punctuation">(</span>DataBuf<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> MPI_INT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*if (0 == Color)                                                                    //组间点对点通信
        {
            int Rank0 = 0;
            MPI_Comm_rank(LocalComm, &amp;Rank0);
            if (0 == Rank0)
                MPI_Send(DataBuf, 3, MPI_INT, 1, 41, InterComm1);
        }
        else if (1 == Color)
        {
            int Rank1 = 0;
            MPI_Comm_rank(LocalComm, &amp;Rank1);
            if (1 == Rank1)
            {
                MPI_Recv(DataBuf, 3, MPI_INT, 0, 41, InterComm1, &amp;Status);
            }
        }*/</span>
    <span class="token punctuation">}</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Current rankID = "</span> <span class="token operator">&lt;&lt;</span> CurrentRank <span class="token operator">&lt;&lt;</span> <span class="token string">", Received Data are: "</span> <span class="token operator">&lt;&lt;</span> DataBuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> DataBuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">","</span> <span class="token operator">&lt;&lt;</span> DataBuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>Color<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
        <span class="token function">MPI_Comm_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
        <span class="token function">MPI_Comm_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>InterComm1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
        <span class="token function">MPI_Comm_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>InterComm2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">MPI_Finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>运行结果如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token operator">></span>mpiexec <span class="token operator">-</span>n <span class="token number">9</span> <span class="token function">MPI16</span><span class="token punctuation">(</span>Intercomm<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
Current rankID <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span>
Current rankID <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
Current rankID <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
Current rankID <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
Current rankID <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
Current rankID <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span>
Current rankID <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span>
Current rankID <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">41</span><span class="token punctuation">,</span><span class="token number">42</span><span class="token punctuation">,</span><span class="token number">43</span>
Current rankID <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span> Received Data are<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们首先将MPI_COMM_WORLD分成了三个组内通信域{0,3,6}、{1,4,7}、{2,5,8}，然后间接通过MPI_COMM_WORLD建立0组和1组之间的组间通信域InterComm1，然后建立1组和2组之间的组间通信域InterComm2，接着我们在第一个组间通信域InterComm1中广播数据，从运行结果中可以看到进程1、4、7号进程都收到了广播的数据（0号进程的数据是广播前自身就有的），而这3个进程和0号进程在不同的组内通信域里，也就是说不同组内通信域的进程之间确实实现了组间通信。</p>
<p>组间通信时，如果使用的是广播方式MPI_Bcast，则发送方通信域只能是根进程在广播，其他进程都不能调用MPI_Bcast，而且根进程在广播时需要指定root参数为MPI_ROOT，而不能使用根进程的进程号来代替，接收方通信域可以使用MPI_Bcast来接收，接收时的root参数应该指定为发送方根进程的进程号（程序中是0）。</p>
<p>如果要在组间通信时使用点对点通信，可以用上面注释的代码来进行，值得注意的是，在点对点组间通信中，对发送和接收的进程都很严格，发送方通信域里只能有一个进程在发送，而接收方通信域里也只能有一个对应的进程在接收，否则会出现死锁（死锁原因没想明白~~~）。这点和组内点对点通信不一样，组内点对点通信时，所有进程都可以调用MPI_Recv函数，只有消息信封吻合时才真正接收消息；但是组间通信时，只能有一个对应的进程在调用MPI_Recv函数，消息信封不吻合的进程不能调用MPI_Recv函数（这段纯属个人yy，若发现不对，强烈欢迎留言指正）。</p>
<hr>
<p>参考文献：</p>
<ol>
<li><a href="http://micro.ustc.edu.cn/Linux/MPI/%E9%AB%98%E9%AB%98%E6%80%A7%E8%83%BD%E8%AE%A1%E7%AE%97%E4%B9%8B%E5%B9%B6%E8%A1%8C%E7%BC%96%E7%A8%8B%E6%8A%80%E6%9C%AF--MPI%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1.pdf" target="_blank" rel="noopener">《高性能计算之并行编程技术— MPI并行程序设计》</a></li>
<li><a href="http://www.cnblogs.com/xbf9xbf/category/780218.html" target="_blank" rel="noopener">《MPI学习记录》</a></li>
<li><a href="https://www.jianshu.com/p/119265e21cdf" target="_blank" rel="noopener">《如何在win10+vs2013上配置MPI并行编程环境》</a></li>
<li><a href="http://mpitutorial.com/tutorials/" target="_blank" rel="noopener">《MPI Tutorial》</a></li>
<li><a href="http://www.cnblogs.com/hantan2008/p/5390375.html" target="_blank" rel="noopener">《用MPI进行分布式内存编程》</a></li>
<li><a href="http://micro.ustc.edu.cn/Linux/MPI/MPICH/index.html" target="_blank" rel="noopener">《MPI中文手册》</a></li>
</ol>
<p>本文所有源码可到这里<a href="https://github.com/Popperelay/BlogCode/tree/master/MPI" target="_blank" rel="noopener">下载</a>。</p>

            </div>

            <!-- Post Comments -->
            
    <!-- 使用 DISQUS_CLICK -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>

<!-- add animation -->
<style>
	.disqus_click_btn {
            line-height: 30px;
            margin: 0;
            min-width: 50px;
            padding: 0 14px;
            display: inline-block;
            font-family: "Roboto", "Helvetica", "Arial", sans-serif;
            font-size: 14px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0;
            overflow: hidden;
            will-change: box-shadow;
            transition: box-shadow .2s cubic-bezier(.4, 0, 1, 1), background-color .2s cubic-bezier(.4, 0, .2, 1), color .2s cubic-bezier(.4, 0, .2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            text-align: center;
            vertical-align: middle;
            border: 0;
            background: rgba(158, 158, 158, .2);
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, .14), 0 3px 1px -2px rgba(0, 0, 0, .2), 0 1px 5px 0 rgba(0, 0, 0, .12);
            color: #fff;
            background-color: #7EC0EE;
            text-shadow: 0
        }
</style>
	
<div class="btn_click_load" id="disqus_bt"> 
    <button class="disqus_click_btn">点击查看评论</button>
</div>

<!--
<script type="text/javascript">
$('.btn_click_load').click(function() {
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'http-miccall-tech'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    document.getElementById('disqus_bt').style.display = "none";
});
</script>
-->
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/04/13/MPI/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://yoursite.com/2018/04/13/MPI/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>

<script type="text/javascript">
    $('.btn_click_load').click(function() {  //click to load comments
        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document;
            var s = d.createElement('script');
            s.src = '//http-miccall-tech.disqus.com/embed.js';
            s.setAttribute('data-timestamp', + new Date());
            (d.head || d.body).appendChild(s);
        })();
        $('.btn_click_load').css('display','none');
    });
</script>
</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>


        </div>
        <!-- Copyright 版权 start -->
                <div id="copyright">
            <ul>
                <li>&copy;Powered By <a href="https://hexo.io/zh-cn/" style="border-bottom: none;">hexo</a></li>
                <li>Design: <a href="http://miccall.tech " style="border-bottom: none;">miccall</a></li>
            </ul>
            
            	<span id="busuanzi_container_site_pv">2019总访问量<span id="busuanzi_value_site_pv"></span>次</span>
			
        </div>
    </div>
</body>



 	
</html>
